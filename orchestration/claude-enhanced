#!/bin/bash
# ============================================================================
# CLAUDE CODE ENHANCED WRAPPER
# 
# Drop-in replacement for 'claude' that automatically suggests orchestration
# when beneficial, but otherwise works exactly like regular Claude Code
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ORCHESTRATE_SCRIPT="$SCRIPT_DIR/claude-orchestrate"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if this is a task that might benefit from orchestration
should_suggest_orchestration() {
    local task_text="$1"
    
    # Keywords that suggest multi-step or multi-agent workflows
    local orchestration_keywords=(
        "create.*and.*test"
        "build.*deploy"
        "design.*implement"
        "review.*fix"
        "document.*code"
        "security.*audit"
        "complete.*project"
        "full.*development"
        "comprehensive"
        "entire.*system"
    )
    
    for keyword in "${orchestration_keywords[@]}"; do
        if echo "$task_text" | grep -qi "$keyword"; then
            return 0  # Should suggest
        fi
    done
    
    return 1  # No suggestion needed
}

# Main execution
main() {
    # If orchestration is disabled, just run regular claude
    if [ "${CLAUDE_ORCHESTRATION,,}" = "off" ]; then
        exec claude "$@"
    fi
    
    # Check if this looks like a task command
    if [ "$1" = "/task" ] || [ "$1" = "task" ]; then
        local task_text="$*"
        
        # Check if orchestration might be beneficial
        if should_suggest_orchestration "$task_text"; then
            echo -e "${CYAN}ðŸ” Analyzing task for orchestration opportunities...${NC}"
            
            # Run orchestration analysis in background
            if "$ORCHESTRATE_SCRIPT" "$task_text" 2>/dev/null; then
                echo ""
                echo -e "${YELLOW}Continue with orchestration? [y/N] or press Enter for regular Claude:${NC} "
                read -t 10 -n 1 response
                echo ""
                
                if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
                    # User chose orchestration
                    exec "$ORCHESTRATE_SCRIPT" "$task_text"
                fi
            fi
        fi
    fi
    
    # Default: run regular Claude Code
    exec claude "$@"
}

# Handle special flags
case "$1" in
    "--orchestration-help")
        cat << EOF
Claude Code Enhanced Wrapper

This wrapper automatically detects when your Claude Code tasks might benefit
from the Python Tandem Orchestration System and offers suggestions.

Usage:
  claude-enhanced [same arguments as regular claude]
  
Examples:
  claude-enhanced /task "create a new feature and test it"
  # â†’ Suggests orchestration for multi-step workflow
  
  claude-enhanced /task "fix this bug"  
  # â†’ Runs regular Claude (no orchestration needed)

Environment Variables:
  CLAUDE_ORCHESTRATION=off    Disable orchestration suggestions
  
The wrapper works as a drop-in replacement for 'claude' but adds intelligence
about when multi-agent workflows would be beneficial.
EOF
        exit 0
        ;;
    "--version")
        echo "Claude Code Enhanced Wrapper v1.0"
        echo "With Python Tandem Orchestration Integration"
        claude --version 2>/dev/null || echo "Claude Code not found"
        exit 0
        ;;
esac

main "$@"