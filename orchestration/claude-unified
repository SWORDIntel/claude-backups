#!/bin/bash
# ============================================================================
# CLAUDE UNIFIED WRAPPER - PERMISSION BYPASS + ORCHESTRATION
# 
# Combines automatic permission bypass (for LiveCD) with intelligent
# orchestration detection and routing through the Tandem Orchestrator
# 
# Version: 2.0 - Unified Architecture
# ============================================================================

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Auto-detect project root
find_project_root() {
    local current_dir="$SCRIPT_DIR"
    while [ "$current_dir" != "/" ]; do
        if [ -d "$current_dir/agents" ] && [ -f "$current_dir/CLAUDE.md" ]; then
            echo "$current_dir"
            return 0
        fi
        current_dir="$(dirname "$current_dir")"
    done
    # Fallback to known location
    echo "/home/siducer/Documents/Claude"
}

PROJECT_ROOT="$(find_project_root)"
AGENTS_DIR="${CLAUDE_AGENTS_DIR:-$PROJECT_ROOT/agents}"
VENV_DIR="$HOME/.local/share/claude/venv"

# Try to find orchestrator in multiple locations
find_orchestrator() {
    local paths=(
        "$AGENTS_DIR/src/python/production_orchestrator.py"
        "$AGENTS_DIR/src/python/tandem_orchestrator.py"
        "$PROJECT_ROOT/agents/src/python/production_orchestrator.py"
        "$PROJECT_ROOT/agents/src/python/tandem_orchestrator.py"
    )
    for path in "${paths[@]}"; do
        if [ -f "$path" ]; then
            echo "$path"
            return 0
        fi
    done
    return 1
}

ORCHESTRATOR_PATH="$(find_orchestrator || echo "")"
ORCHESTRATION_BRIDGE="$SCRIPT_DIR/claude-orchestration-bridge.py"

# Colors
readonly CYAN='\033[0;36m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly MAGENTA='\033[0;35m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'

# Permission bypass configuration
PERMISSION_BYPASS_ENABLED=${CLAUDE_PERMISSION_BYPASS:-true}
ORCHESTRATION_ENABLED=${CLAUDE_ORCHESTRATION:-true}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

log_info() {
    echo -e "${GREEN}[UNIFIED]${NC} $1" >&2
}

log_orchestration() {
    echo -e "${CYAN}[ORCHESTRATE]${NC} $1" >&2
}

log_permission() {
    echo -e "${YELLOW}[PERMISSION]${NC} $1" >&2
}

# Find the actual Claude binary (not this wrapper)
find_claude_binary() {
    local claude_bin=""
    
    # Check common locations for the real Claude binary
    for loc in \
        "$HOME/.local/npm-global/bin/claude.original" \
        "$HOME/.local/bin/claude.original" \
        "/usr/local/bin/claude.original" \
        "$(which claude-actual 2>/dev/null)" \
        "$(npm root -g 2>/dev/null)/@anthropic-ai/claude-code/bin/claude" \
        "$HOME/.npm-global/bin/claude" \
        "$HOME/.local/npm-global/bin/claude"
    do
        if [ -n "$loc" ] && [ -f "$loc" ] && [ -x "$loc" ] && [ "$loc" != "$0" ]; then
            # Make sure it's the actual claude binary, not another wrapper
            if ! grep -q "CLAUDE UNIFIED WRAPPER" "$loc" 2>/dev/null; then
                claude_bin="$loc"
                break
            fi
        fi
    done
    
    # If no .original found, look for regular claude (but not this script)
    if [ -z "$claude_bin" ]; then
        local system_claude=$(which claude 2>/dev/null)
        if [ -n "$system_claude" ] && [ "$system_claude" != "$0" ]; then
            # Make sure it's the actual claude binary, not another wrapper
            if ! grep -q "CLAUDE UNIFIED WRAPPER" "$system_claude" 2>/dev/null; then
                claude_bin="$system_claude"
            fi
        fi
    fi
    
    echo "$claude_bin"
}

# Check if orchestration should be suggested
should_orchestrate() {
    local task_text="$*"
    
    # Quick exit if orchestration is disabled
    [ "$ORCHESTRATION_ENABLED" = "false" ] && return 1
    
    # Multi-agent workflow patterns
    local patterns=(
        "create.*and.*test"
        "build.*deploy"
        "design.*implement"
        "review.*fix"
        "document.*code"
        "security.*audit"
        "complete.*project"
        "full.*development"
        "comprehensive"
        "entire.*system"
        "multi.*agent"
        "orchestrat"
        "workflow"
        "pipeline"
    )
    
    for pattern in "${patterns[@]}"; do
        if echo "$task_text" | grep -qi "$pattern"; then
            return 0
        fi
    done
    
    return 1
}

# ============================================================================
# ORCHESTRATION INTEGRATION
# ============================================================================

run_with_orchestration() {
    local claude_bin="$1"
    shift
    local args=("$@")
    
    log_orchestration "Detected multi-agent workflow opportunity"
    
    # Check if orchestrator is available
    if [ -n "$ORCHESTRATOR_PATH" ] && [ -f "$ORCHESTRATOR_PATH" ]; then
        echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║         ${BOLD}Tandem Orchestration System Available${NC}${CYAN}             ║${NC}"
        echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "${GREEN}Detected task that could benefit from multi-agent coordination.${NC}"
        echo ""
        echo "Options:"
        echo "  [1] Use Tandem Orchestrator (recommended for complex tasks)"
        echo "  [2] Use regular Claude Code"
        echo "  [3] Show orchestration analysis"
        echo ""
        echo -n "Choice [1-3, default=2]: "
        
        read -t 10 -n 1 choice || choice="2"
        echo ""
        
        case "$choice" in
            1)
                log_orchestration "Launching Tandem Orchestrator..."
                
                # Activate venv if available
                if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
                    source "$VENV_DIR/bin/activate"
                    log_info "Virtual environment activated"
                fi
                
                # Set up environment
                export CLAUDE_BINARY="$claude_bin"
                export CLAUDE_PERMISSION_BYPASS="$PERMISSION_BYPASS_ENABLED"
                export CLAUDE_PROJECT_ROOT="$PROJECT_ROOT"
                export CLAUDE_AGENTS_DIR="$AGENTS_DIR"
                export PYTHONPATH="$(dirname "$ORCHESTRATOR_PATH"):$AGENTS_DIR/src/python:$PYTHONPATH"
                
                # Launch orchestrator with task
                cd "$(dirname "$ORCHESTRATOR_PATH")"
                python3 "$(basename "$ORCHESTRATOR_PATH")" --task "${args[@]}"
                exit $?
                ;;
            3)
                # Show analysis
                echo -e "${CYAN}Task Analysis:${NC}"
                
                # Activate venv if available
                if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
                    source "$VENV_DIR/bin/activate"
                fi
                
                export PYTHONPATH="$(dirname "$ORCHESTRATOR_PATH"):$AGENTS_DIR/src/python:$PYTHONPATH"
                export CLAUDE_AGENTS_DIR="$AGENTS_DIR"
                
                python3 -c "
import sys
import os
task = ' '.join(sys.argv[1:])
print(f'Task: {task}')
print('Suggested agents:')
if 'test' in task.lower():
    print('  - testbed: Create comprehensive tests')
if 'security' in task.lower():
    print('  - security: Security analysis')
    print('  - securitychaosagent: Chaos testing')
if 'document' in task.lower():
    print('  - docgen: Documentation generation')
if 'deploy' in task.lower():
    print('  - deployer: Deployment orchestration')
if 'architect' in task.lower() or 'design' in task.lower():
    print('  - architect: System design')
if 'debug' in task.lower() or 'fix' in task.lower():
    print('  - debugger: Debug issues')
    print('  - patcher: Apply fixes')
print('')
print('Execution mode: INTELLIGENT (Python orchestrates)')
print(f'Agents directory: {os.environ.get(\"CLAUDE_AGENTS_DIR\", \"Not set\")}')
" "${args[@]}"
                echo ""
                echo -n "Continue with orchestrator? [y/N]: "
                read -n 1 use_orch
                echo ""
                if [ "$use_orch" = "y" ] || [ "$use_orch" = "Y" ]; then
                    export CLAUDE_PROJECT_ROOT="$PROJECT_ROOT"
                    export CLAUDE_AGENTS_DIR="$AGENTS_DIR"
                    cd "$(dirname "$ORCHESTRATOR_PATH")"
                    python3 "$(basename "$ORCHESTRATOR_PATH")" --task "${args[@]}"
                    exit $?
                fi
                ;;
        esac
    fi
    
    # Fall through to regular execution
    return 1
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    local claude_bin=$(find_claude_binary)
    
    # Check if Claude is installed
    if [ -z "$claude_bin" ]; then
        echo -e "${YELLOW}Claude Code not found!${NC}"
        echo ""
        echo "To install Claude Code:"
        echo "  npm install -g @anthropic-ai/claude-code"
        echo ""
        echo "This unified wrapper provides:"
        echo "  • Automatic permission bypass (LiveCD mode)"
        echo "  • Tandem Orchestration integration"
        echo "  • Intelligent workflow detection"
        exit 1
    fi
    
    # Parse arguments
    local args=()
    local skip_permissions=true
    local task_mode=false
    
    for arg in "$@"; do
        case "$arg" in
            --no-skip-permissions|--safe)
                skip_permissions=false
                ;;
            --dangerously-skip-permissions)
                # Already requesting skip, don't add it twice
                skip_permissions=false
                args+=("$arg")
                ;;
            /task|task)
                task_mode=true
                args+=("$arg")
                ;;
            *)
                args+=("$arg")
                ;;
        esac
    done
    
    # Check for orchestration opportunity
    if [ "$task_mode" = true ] && [ "$ORCHESTRATION_ENABLED" != "false" ]; then
        if should_orchestrate "${args[@]}"; then
            if run_with_orchestration "$claude_bin" "${args[@]}"; then
                exit 0
            fi
        fi
    fi
    
    # Add permission bypass if enabled and not explicitly disabled
    if [ "$PERMISSION_BYPASS_ENABLED" = "true" ] && [ "$skip_permissions" = true ]; then
        log_permission "Auto-adding permission bypass (LiveCD mode)"
        args=("--dangerously-skip-permissions" "${args[@]}")
    fi
    
    # Execute Claude with final arguments
    exec "$claude_bin" "${args[@]}"
}

# ============================================================================
# SPECIAL COMMANDS
# ============================================================================

case "${1:-}" in
    --unified-help)
        cat << EOF
${BOLD}Claude Unified Wrapper v2.0${NC}
Automatic Permission Bypass + Tandem Orchestration

This wrapper combines:
  1. Automatic permission bypass for LiveCD environments
  2. Intelligent orchestration detection for multi-agent workflows
  3. Seamless integration with existing Claude Code

${BOLD}Usage:${NC}
  claude-unified [arguments]  # Same as regular claude

${BOLD}Features:${NC}
  • ${YELLOW}Permission Bypass${NC}: Automatically adds --dangerously-skip-permissions
  • ${CYAN}Orchestration${NC}: Detects complex tasks and suggests multi-agent coordination
  • ${GREEN}Intelligent Routing${NC}: Routes to appropriate execution layer

${BOLD}Environment Variables:${NC}
  CLAUDE_PERMISSION_BYPASS=false  # Disable automatic permission bypass
  CLAUDE_ORCHESTRATION=false      # Disable orchestration suggestions
  CLAUDE_AGENTS_DIR               # Path to agents directory

${BOLD}Examples:${NC}
  claude-unified /task "create feature with tests"
    → Suggests orchestration, adds permission bypass

  claude-unified --safe /task "simple fix"
    → No permission bypass, no orchestration

  CLAUDE_ORCHESTRATION=false claude-unified /task "anything"
    → Permission bypass only, no orchestration

${BOLD}Orchestration Keywords:${NC}
  • Multi-step: "create and test", "build and deploy"
  • Comprehensive: "full development", "entire system"
  • Workflows: "pipeline", "orchestrate", "workflow"

EOF
        exit 0
        ;;
    --unified-status)
        echo -e "${BOLD}Unified Wrapper Status:${NC}"
        echo ""
        
        # Project root
        echo -e "Project Root: ${GREEN}$PROJECT_ROOT${NC}"
        
        # Claude binary
        claude_bin=$(find_claude_binary)
        if [ -n "$claude_bin" ]; then
            echo -e "Claude Binary: ${GREEN}✓${NC} ${claude_bin#$HOME/}"
        else
            echo -e "Claude Binary: ${YELLOW}✗${NC} Not found"
        fi
        
        # Permission bypass
        if [ "${CLAUDE_PERMISSION_BYPASS:-true}" = "false" ]; then
            echo -e "Permission Bypass: ${YELLOW}Disabled${NC}"
        else
            echo -e "Permission Bypass: ${GREEN}Enabled (default)${NC}"
        fi
        
        # Virtual environment
        if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
            echo -e "Python venv: ${GREEN}✓${NC} $VENV_DIR"
        else
            echo -e "Python venv: ${YELLOW}✗${NC} Not created"
        fi
        
        # Orchestration
        if [ "${CLAUDE_ORCHESTRATION:-true}" = "false" ]; then
            echo -e "Orchestration: ${YELLOW}Disabled${NC}"
        elif [ -n "$ORCHESTRATOR_PATH" ] && [ -f "$ORCHESTRATOR_PATH" ]; then
            echo -e "Orchestration: ${GREEN}✓ Available${NC}"
            echo "  Path: ${ORCHESTRATOR_PATH#$PROJECT_ROOT/}"
        else
            echo -e "Orchestration: ${YELLOW}✗${NC} Not found"
            echo "  Searched in: $AGENTS_DIR/src/python/"
        fi
        
        # Agents
        if [ -d "$AGENTS_DIR" ]; then
            # Count main agent files (uppercase .md files in agents root)
            agent_count=$(find "$AGENTS_DIR" -maxdepth 1 -name "*.md" -type f 2>/dev/null | grep -E '[A-Z]+\.md$' | wc -l)
            py_files=$(find "$AGENTS_DIR/src/python" -name "*.py" 2>/dev/null | wc -l)
            echo -e "Agents: ${GREEN}✓${NC} $agent_count agents, $py_files Python files"
            echo "  Directory: ${AGENTS_DIR#$PROJECT_ROOT/}"
        else
            echo -e "Agents: ${YELLOW}✗${NC} Directory not found"
        fi
        
        exit 0
        ;;
esac

# Run main execution
main "$@"