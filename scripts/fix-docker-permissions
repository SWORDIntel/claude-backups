#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# Docker Permissions Fix Script
# Fixes Docker daemon socket permission issues
# ═══════════════════════════════════════════════════════════════════════════

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

echo -e "${BOLD}${CYAN}Docker Permissions Fix${RESET}"
echo -e "${CYAN}Fixing Docker daemon socket permission issues...${RESET}"
echo

# Check if Docker is installed
if ! command -v docker >/dev/null 2>&1; then
    echo -e "${RED}Error: Docker is not installed${RESET}"
    exit 1
fi

# Check current permissions
echo -e "${YELLOW}Current Docker status:${RESET}"
if docker ps >/dev/null 2>&1; then
    echo -e "${GREEN}✓ Docker access working${RESET}"
    exit 0
else
    echo -e "${RED}✗ Docker permission denied${RESET}"
fi

echo -e "${YELLOW}Current user groups:${RESET}"
groups $USER

echo
echo -e "${BOLD}${CYAN}Available fixes:${RESET}"
echo -e "${YELLOW}1. Add user to docker group (requires logout/login)${RESET}"
echo -e "${YELLOW}2. Use newgrp for immediate access${RESET}"
echo -e "${YELLOW}3. Show sudo commands for one-time use${RESET}"
echo

read -p "Choose fix method [1-3]: " -n 1 -r
echo

case $REPLY in
    1)
        echo -e "${CYAN}Adding user to docker group...${RESET}"
        if sudo usermod -aG docker $USER; then
            echo -e "${GREEN}✓ User added to docker group${RESET}"
            echo -e "${YELLOW}You need to log out and log back in, or run:${RESET}"
            echo -e "${CYAN}  newgrp docker${RESET}"
        else
            echo -e "${RED}Error: Failed to add user to docker group${RESET}"
            exit 1
        fi
        ;;
    2)
        echo -e "${CYAN}Using newgrp for immediate access...${RESET}"
        echo -e "${YELLOW}Note: This only works for the current session${RESET}"
        echo -e "${CYAN}Run: newgrp docker${RESET}"
        echo -e "${CYAN}Then test: docker ps${RESET}"
        ;;
    3)
        echo -e "${CYAN}Sudo commands for one-time use:${RESET}"
        echo -e "${YELLOW}Check Docker status:${RESET}"
        echo -e "${CYAN}  sudo docker ps${RESET}"
        echo -e "${YELLOW}Stop Claude containers:${RESET}"
        echo -e "${CYAN}  sudo docker stop claude-postgres claude-learning claude-bridge${RESET}"
        echo -e "${YELLOW}Remove Claude containers:${RESET}"
        echo -e "${CYAN}  sudo docker rm claude-postgres claude-learning claude-bridge${RESET}"
        echo -e "${YELLOW}Remove Claude volumes:${RESET}"
        echo -e "${CYAN}  sudo docker volume rm claude-postgres-data claude-learning-data${RESET}"
        ;;
    *)
        echo -e "${RED}Invalid choice${RESET}"
        exit 1
        ;;
esac

echo
echo -e "${BOLD}${GREEN}Docker permissions fix instructions provided${RESET}"
echo -e "${CYAN}Note: For permanent fix, option 1 is recommended${RESET}"