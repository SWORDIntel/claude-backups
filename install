#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# Claude Installation Script - Security Hardened v2.0
# Implements: Path validation, sudo hardening, install locking, audit trail
#
# NOTE: For complete installation of all 10 modules (Shadowgit, NPU, OpenVINO,
#       Database, Learning System, etc.), use: ./install-complete.sh
#       This script installs Claude Code CLI only.
# ═══════════════════════════════════════════════════════════════════════════

set -euo pipefail

# Colors for output
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RED='\033[0;31m'
RESET='\033[0m'

# Binary paths for security (VULN-002 fix)
readonly SUDO_BIN="/usr/bin/sudo"
readonly NPM_BIN="/usr/bin/npm"

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load state management module
if [[ -f "$SCRIPT_DIR/lib/state.sh" ]]; then
    source "$SCRIPT_DIR/lib/state.sh" || {
        echo -e "${RED}ERROR: Failed to load state management${RESET}" >&2
        exit 1
    }
else
    # Stub functions for compatibility
    state_init() { return 0; }
    state_save() { return 0; }
    state_lock() { return 0; }
    state_unlock() { return 0; }
    state_cleanup_on_exit() { return 0; }
fi

# ═══════════════════════════════════════════════════════════════════════════
# SECURITY FUNCTIONS
# ═══════════════════════════════════════════════════════════════════════════

# VULN-001 FIX: Secure npm prefix validation
get_safe_npm_prefix() {
    local raw_prefix

    if ! raw_prefix="$(npm config get prefix 2>/dev/null)"; then
        echo "/usr/local"
        return 0
    fi

    # Sanitize whitespace
    raw_prefix=$(echo "$raw_prefix" | tr -d '\n\r\t' | xargs)

    # Validate: absolute path with safe characters only
    if ! echo "$raw_prefix" | grep -qE '^/[a-zA-Z0-9/_.-]+$'; then
        echo -e "${YELLOW}WARNING: Invalid npm prefix: $raw_prefix${RESET}" >&2
        echo "/usr/local"
        return 1
    fi

    # Reject shell metacharacters
    if echo "$raw_prefix" | grep -qE '[;&|`$(){}]'; then
        echo -e "${RED}ERROR: Shell metacharacters in npm prefix${RESET}" >&2
        echo "/usr/local"
        return 1
    fi

    # Resolve canonical path
    if command -v readlink >/dev/null 2>&1; then
        local canonical
        canonical=$(readlink -f "$raw_prefix" 2>/dev/null) && raw_prefix="$canonical"
    fi

    # Reject path traversal
    if [[ "$raw_prefix" =~ \.\. ]]; then
        echo -e "${RED}ERROR: Path traversal detected${RESET}" >&2
        echo "/usr/local"
        return 1
    fi

    # Length check
    if [[ ${#raw_prefix} -gt 255 ]]; then
        echo -e "${RED}ERROR: Path too long${RESET}" >&2
        echo "/usr/local"
        return 1
    fi

    echo "$raw_prefix"
}

# VULN-002 FIX: Validate sudo binary
validate_sudo_binary() {
    if [[ ! -x "$SUDO_BIN" ]]; then
        echo -e "${RED}ERROR: sudo not found at $SUDO_BIN${RESET}" >&2
        return 1
    fi

    if [[ -L "$SUDO_BIN" ]]; then
        echo -e "${RED}ERROR: sudo is a symlink (security risk)${RESET}" >&2
        return 1
    fi

    local sudo_owner
    sudo_owner=$(stat -c %u "$SUDO_BIN" 2>/dev/null || stat -f %u "$SUDO_BIN" 2>/dev/null)
    if [[ "$sudo_owner" != "0" ]]; then
        echo -e "${RED}ERROR: sudo not owned by root${RESET}" >&2
        return 1
    fi

    return 0
}

# VULN-003 FIX: Audit trail logging
log_consent() {
    local action="$1"
    local decision="${2:-GRANTED}"

    local audit_dir="${XDG_STATE_HOME:-$HOME/.local/state}/claude"
    mkdir -p "$audit_dir" 2>/dev/null || return 0

    local audit_log="$audit_dir/audit.log"
    echo "$(date -Iseconds)|$USER|$action|$decision|PID:$$" >> "$audit_log" 2>/dev/null || true

    # Rotate if > 1MB
    if [[ -f "$audit_log" ]] && [[ $(stat -c%s "$audit_log" 2>/dev/null || echo 0) -gt 1048576 ]]; then
        mv "$audit_log" "${audit_log}.$(date +%Y%m%d)" 2>/dev/null || true
    fi
}

# VULN-003 FIX: Request user consent
request_shell_config_consent() {
    echo -e "${YELLOW}╔════════════════════════════════════════════════════╗${RESET}"
    echo -e "${YELLOW}║  Shell Configuration Modification Required        ║${RESET}"
    echo -e "${YELLOW}╚════════════════════════════════════════════════════╝${RESET}"
    echo ""
    echo "Claude Code needs to add ~/.npm-global/bin to your PATH."
    echo "Files to modify: ~/.bashrc, ~/.profile, ~/.zshrc"
    echo "Timestamped backups will be created."
    echo ""
    echo -n "Proceed? [y/N] (30s timeout): "

    local response
    if read -t 30 -r response 2>/dev/null; then
        if [[ "$response" =~ ^[Yy]$ ]]; then
            log_consent "shell_config" "GRANTED"
            return 0
        fi
    fi

    log_consent "shell_config" "DENIED"
    return 1
}

# ═══════════════════════════════════════════════════════════════════════════
# MAIN INSTALLATION LOGIC
# ═══════════════════════════════════════════════════════════════════════════

# Print header
echo -e "${BOLD}${CYAN}Claude Code CLI - Quick Install${RESET}"
echo -e "${CYAN}For complete system installation (all 10 modules), use: ./install-complete.sh${RESET}"
echo -e "${CYAN}This script installs Claude Code CLI only${RESET}"
echo

# Check for Python installer
PYTHON_INSTALLER="$SCRIPT_DIR/claude-python-installer.sh"
if [[ ! -f "$PYTHON_INSTALLER" ]]; then
    echo -e "${YELLOW}Python installer not found. Trying alternative locations...${RESET}"

    for location in \
        "$SCRIPT_DIR/claude-enhanced-installer.py" \
        "$SCRIPT_DIR/claude-enhanced-installer-venv.py" \
        "$HOME/claude-backups/claude-python-installer.sh" \
        "$HOME/Documents/Claude/claude-python-installer.sh"; do

        if [[ -f "$location" ]]; then
            if [[ "$location" == *.py ]]; then
                echo -e "${GREEN}Found Python installer: $location${RESET}"
                exec python3 "$location" "$@"
            else
                echo -e "${GREEN}Found installer: $location${RESET}"
                exec "$location" "$@"
            fi
        fi
    done

    echo -e "${YELLOW}No installer found. Creating basic installation...${RESET}"

    # Initialize state management
    state_init || echo -e "${YELLOW}Note: State management unavailable${RESET}"

    # STREAM 2: Acquire install lock (RACE-CONDITION FIX)
    if ! state_lock "install"; then
        LOCK_FILE="/tmp/claude-install-$USER.lock"
        if ! mkdir "$LOCK_FILE" 2>/dev/null; then
            echo -e "${RED}ERROR: Another installation in progress${RESET}" >&2
            echo -e "${YELLOW}If stuck, remove: $LOCK_FILE${RESET}" >&2
            exit 1
        fi
        echo $$ > "$LOCK_FILE/pid"
        trap 'rm -rf "$LOCK_FILE" 2>/dev/null' EXIT INT TERM
    else
        trap 'state_unlock "install"; state_cleanup_on_exit' EXIT INT TERM
    fi

    # RACE-001 FIX: Cleanup tracking for temporary files
    CLEANUP_FILES=()
    cleanup_temp_files() {
        for file in "${CLEANUP_FILES[@]}"; do
            [[ -f "$file" ]] && rm -f "$file" 2>/dev/null
        done
    }
    trap 'cleanup_temp_files; state_unlock "install" 2>/dev/null; state_cleanup_on_exit 2>/dev/null' EXIT INT TERM

    # Basic npm installation as fallback
    echo "Installing Claude Code via npm..."
    if command -v npm >/dev/null 2>&1; then
        # Validate binaries if sudo might be needed
        if [[ -x "$SUDO_BIN" ]]; then
            validate_sudo_binary || echo -e "${YELLOW}Note: Sudo validation unavailable${RESET}"
        fi

        # VULN-001 FIX: Get validated npm prefix
        NPM_PREFIX="$(get_safe_npm_prefix)"
        PACKAGE_PATH="$NPM_PREFIX/lib/node_modules/@anthropic-ai/claude-code"

        # Check if package already exists and is owned by root
        NEEDS_USER_INSTALL=false
        if [[ -d "$PACKAGE_PATH" ]]; then
            OWNER=$(stat -c '%U' "$PACKAGE_PATH" 2>/dev/null || stat -f '%Su' "$PACKAGE_PATH" 2>/dev/null || echo "")
            if [[ -n "$OWNER" ]] && [[ "$OWNER" == "root" ]] && [[ "$(whoami)" != "root" ]]; then
                echo -e "${YELLOW}Found existing root-owned Claude Code installation${RESET}"
                echo "Removing root-owned package to enable user-level installation..."
                if "$SUDO_BIN" "$NPM_BIN" uninstall -g @anthropic-ai/claude-code >/dev/null 2>&1; then
                    echo -e "${GREEN}✓ Removed root-owned package${RESET}"
                else
                    echo -e "${YELLOW}Warning: Could not remove root package${RESET}"
                fi
                NEEDS_USER_INSTALL=true
            fi
        fi

        # RACE-001 FIX: Test write capability with mktemp
        if [[ "$NEEDS_USER_INSTALL" == "false" ]]; then
            test_file=""
            if test_file=$(mktemp "$NPM_PREFIX/lib/node_modules/.npm-write-test.XXXXXX" 2>/dev/null); then
                CLEANUP_FILES+=("$test_file")
                rm -f "$test_file" 2>/dev/null
                NEEDS_USER_INSTALL=false
            else
                NEEDS_USER_INSTALL=true
            fi
        fi

        # Set up user-level npm if needed
        if [[ "$NEEDS_USER_INSTALL" == "true" ]]; then
            echo "Setting up user-level npm directory..."
            if ! mkdir -p "$HOME/.npm-global"; then
                echo -e "${YELLOW}Warning: Failed to create $HOME/.npm-global${RESET}"
                echo "Will attempt with sudo..."
            elif ! npm config set prefix "$HOME/.npm-global"; then
                echo -e "${YELLOW}Warning: Failed to configure npm prefix${RESET}"
                echo "Will attempt with sudo..."
            else
                # VULN-003 FIX: Request consent for shell modification
                if request_shell_config_consent; then
                    echo -e "${GREEN}Adding npm global bin to PATH...${RESET}"

                    # RACE-002 FIX: Use flock for atomic config updates
                    for config_file in "$HOME/.bashrc" "$HOME/.profile" "$HOME/.zshrc"; do
                        if [[ -f "$config_file" ]]; then
                            backup=""
                            backup="${config_file}.backup-$(date +%s)"
                            cp "$config_file" "$backup" 2>/dev/null

                            lockfile="${config_file}.lock"
                            (
                                if flock -x -w 10 200 2>/dev/null; then
                                    if ! grep -qF '.npm-global/bin' "$config_file" 2>/dev/null; then
                                        echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> "$config_file"
                                        echo -e "${GREEN}✓ Updated: $config_file${RESET}"
                                    fi
                                fi
                            ) 200>"$lockfile"
                            rm -f "$lockfile"
                        fi
                    done

                    export PATH="$HOME/.npm-global/bin:$PATH"
                else
                    echo -e "${YELLOW}Shell config not modified. Add manually:${RESET}"
                    echo -e "${CYAN}  export PATH=\"\$HOME/.npm-global/bin:\$PATH\"${RESET}"
                    export PATH="$HOME/.npm-global/bin:$PATH"
                fi
            fi
        fi

        # Install Claude Code
        if npm install -g @anthropic-ai/claude-code; then
            echo -e "${GREEN}✓ Claude Code installed successfully${RESET}"
            echo -e "${CYAN}You can now use 'claude' command${RESET}"
            if [[ "$NEEDS_USER_INSTALL" == "true" ]]; then
                echo -e "${YELLOW}Note: Restart terminal or run: source ~/.bashrc${RESET}"
            fi
        else
            echo -e "${YELLOW}Installation failed. Attempting with sudo...${RESET}"

            npm config delete prefix 2>/dev/null

            # VULN-002 FIX: Use validated sudo
            if "$SUDO_BIN" "$NPM_BIN" install -g @anthropic-ai/claude-code; then
                echo -e "${GREEN}✓ Claude Code installed with sudo${RESET}"
                echo -e "${CYAN}You can now use 'claude' command${RESET}"
            else
                echo -e "\n${YELLOW}═══════════════════════════════════════════════════${RESET}"
                echo -e "${YELLOW}ERROR: Installation failed${RESET}"
                echo -e "${YELLOW}═══════════════════════════════════════════════════${RESET}"
                echo -e "\n${BOLD}Possible solutions:${RESET}"
                echo -e "1. Clean up and try again:"
                echo -e "   ${CYAN}sudo npm uninstall -g @anthropic-ai/claude-code${RESET}"
                echo -e "   ${CYAN}rm -rf ~/.npm-global${RESET}"
                echo -e "   ${CYAN}npm config delete prefix${RESET}"
                echo -e "   ${CYAN}./install${RESET}"
                echo -e "\n2. Manual installation:"
                echo -e "   ${CYAN}mkdir -p ~/.npm-global${RESET}"
                echo -e "   ${CYAN}npm config set prefix ~/.npm-global${RESET}"
                echo -e "   ${CYAN}export PATH=~/.npm-global/bin:\$PATH${RESET}"
                echo -e "   ${CYAN}npm install -g @anthropic-ai/claude-code${RESET}"
                exit 1
            fi
        fi
    else
        echo "Error: npm not found. Please install Node.js first."
        exit 1
    fi
else
    # Launch Python installer
    exec "$PYTHON_INSTALLER" "$@"
fi
