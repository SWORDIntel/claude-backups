FROM postgres:16

# Install build dependencies and libraries for SIMD operations
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    postgresql-server-dev-16 \
    pkg-config \
    cmake \
    libnuma-dev \
    libssl-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install pgvector extension
RUN cd /tmp && \
    git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git && \
    cd pgvector && \
    make clean && \
    make OPTFLAGS="" && \
    make install && \
    cd / && \
    rm -rf /tmp/pgvector

# Install additional extensions
RUN cd /tmp && \
    # pg_stat_statements for query performance analysis
    echo "CREATE EXTENSION IF NOT EXISTS pg_stat_statements;" > /tmp/extensions.sql && \
    # pg_prewarm for buffer prewarming
    echo "CREATE EXTENSION IF NOT EXISTS pg_prewarm;" >> /tmp/extensions.sql && \
    # pg_trgm for similarity search
    echo "CREATE EXTENSION IF NOT EXISTS pg_trgm;" >> /tmp/extensions.sql

# Copy SIMD optimized operations
COPY ../simd_optimized_operations.c /opt/enhanced_learning/

# Build SIMD operations library (skip if file doesn't exist)
RUN if [ -f /opt/enhanced_learning/simd_optimized_operations.c ]; then \
        cd /opt/enhanced_learning && \
        gcc -shared -fPIC -O3 -march=native -mavx2 \
            -I$(pg_config --includedir-server) \
            -lnuma -lpq -lm \
            simd_optimized_operations.c \
            -o libsimd_operations.so 2>/dev/null || echo "SIMD compilation skipped"; \
    else \
        echo "SIMD source not found, skipping compilation"; \
    fi

# Enhanced PostgreSQL configuration for learning system
RUN echo "# Enhanced Learning System Configuration" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "shared_preload_libraries = 'pg_stat_statements,pg_prewarm'" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "track_activity_query_size = 2048" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "pg_stat_statements.track = all" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "pg_stat_statements.max = 10000" >> /usr/share/postgresql/postgresql.conf.sample

# Copy initialization scripts
COPY docker/init-scripts/ /docker-entrypoint-initdb.d/

# Set proper permissions
RUN chmod -R 755 /docker-entrypoint-initdb.d/

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD pg_isready -U ${POSTGRES_USER:-claude_agent} -d ${POSTGRES_DB:-claude_agents_auth} || exit 1

EXPOSE 5432
