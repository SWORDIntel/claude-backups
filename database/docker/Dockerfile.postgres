# PostgreSQL 16 with pgvector extension for Claude Agent Framework
FROM postgres:16

LABEL maintainer="Claude Agent Framework"
LABEL description="PostgreSQL 17 with pgvector extension for agent learning system"

# Install build dependencies and pgvector
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    postgresql-server-dev-17 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install pgvector extension
RUN cd /tmp \
    && git clone --branch v0.8.0 https://github.com/pgvector/pgvector.git \
    && cd pgvector \
    && make clean \
    && make OPTFLAGS="" \
    && make install \
    && cd / \
    && rm -rf /tmp/pgvector

# PostgreSQL 17 optimized configuration
RUN echo "# PostgreSQL 17 Performance Optimization for Claude Agents" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_connections = 200" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "shared_buffers = 256MB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "effective_cache_size = 1GB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "maintenance_work_mem = 64MB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "checkpoint_completion_target = 0.9" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "wal_buffers = 16MB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "default_statistics_target = 100" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "random_page_cost = 1.1" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "effective_io_concurrency = 200" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "work_mem = 4MB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "min_wal_size = 1GB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_wal_size = 4GB" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_worker_processes = 8" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_parallel_workers_per_gather = 4" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_parallel_workers = 8" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "max_parallel_maintenance_workers = 4" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_min_duration_statement = 1000" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_checkpoints = on" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_connections = on" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_disconnections = on" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_lock_waits = on" >> /usr/share/postgresql/postgresql.conf.sample \
    && echo "log_temp_files = 0" >> /usr/share/postgresql/postgresql.conf.sample

# Enable pgvector extension in initialization
RUN echo "CREATE EXTENSION IF NOT EXISTS vector;" > /docker-entrypoint-initdb.d/00-enable-vector.sql

# Copy PostgreSQL 16/17 compatible schemas
COPY sql/ /docker-entrypoint-initdb.d/

# Set socket directory permissions
RUN mkdir -p /var/run/postgresql && chown postgres:postgres /var/run/postgresql

# Health check script
COPY docker/healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/healthcheck.sh

HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD /usr/local/bin/healthcheck.sh

EXPOSE 5432

USER postgres