#!/bin/bash
# Claude Quick Installer - Intelligent wrapper for claude-enhanced-installer-venv.py
# Automatically detects and handles various installation scenarios

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INSTALLER_SCRIPT="$SCRIPT_DIR/installers/claude/claude-enhanced-installer.py"

# Banner
print_banner() {
    echo "======================================================================"
    echo -e "${BOLD}Claude Military Installer v7.0 - 40+ TFLOPS + Local Opus${NC}"
    echo "Intel Meteor Lake optimized with 98-agent coordination"
    echo "Military-grade hardware optimization + Token-free local inference"
    echo "======================================================================"
    echo ""
}

# Install all system dependencies
install_dependencies() {
    echo ""
    echo -e "${CYAN}Installing system dependencies...${NC}"
    echo ""

    DEPS=(
        "build-essential"
        "python3-full" "python3-pip" "python3-venv" "python-is-python3" "pipx"
        "libnuma-dev" "liburing-dev" "librdkafka-dev"
        "libssl-dev" "libpcre2-dev"
        "docker.io"
        "curl" "wget" "git"
    )

    echo "The following packages will be installed:"
    printf '  - %s\n' "${DEPS[@]}"
    echo ""

    echo -e "${YELLOW}You will be prompted for your sudo password.${NC}"
    sudo apt-get update
    sudo apt-get install -y "${DEPS[@]}"

    # Try to install gcc-15/g++-15 if available (optional)
    echo ""
    echo -e "${CYAN}Checking for gcc-15/g++-15...${NC}"
    if sudo apt-get install -y gcc-15 g++-15 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} gcc-15 and g++-15 installed"
    else
        echo -e "  ${BLUE}ℹ${NC} gcc-15/g++-15 not available, using default gcc from build-essential"
    fi

    echo ""

    # Install Rust toolchain if not present
    if ! command -v cargo &> /dev/null; then
        echo -e "${CYAN}Installing Rust toolchain...${NC}"
        echo -e "${YELLOW}This may take 2-3 minutes...${NC}"

        # Determine actual user home directory (even when running with sudo)
        if [[ -n "$SUDO_USER" ]]; then
            USER_HOME=$(eval echo ~"$SUDO_USER")
        else
            USER_HOME="$HOME"
        fi

        # Install Rust as the actual user (not root)
        if [[ $EUID -eq 0 ]] && [[ -n "$SUDO_USER" ]]; then
            # Running with sudo - install as the actual user
            sudo -u "$SUDO_USER" bash -c 'curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'
            echo -e "  ${GREEN}✓${NC} Rust installed for user $SUDO_USER"
        else
            # Running as regular user
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env" 2>/dev/null || export PATH="$HOME/.cargo/bin:$PATH"
            echo -e "  ${GREEN}✓${NC} Rust installed"
        fi
    else
        echo -e "  ${GREEN}✓${NC} Rust already installed"
    fi

    # Add user to docker group
    if groups | grep -q docker; then
        echo -e "  ${GREEN}✓${NC} User already in docker group"
    else
        echo -e "${CYAN}Adding user to docker group...${NC}"
        sudo usermod -aG docker "$USER"
        echo -e "  ${YELLOW}⚠${NC} You may need to logout/login for docker group to take effect"
    fi

    echo ""
}

# Check prerequisites
check_prerequisites() {
    local missing=()

    echo -e "${CYAN}Checking prerequisites...${NC}"

    # Check Python
    if ! command -v python3 &> /dev/null; then
        missing+=("python3")
    else
        python_version=$(python3 --version 2>&1 | awk '{print $2}')
        echo -e "  ${GREEN}✓${NC} Python $python_version"
    fi

    # Check Node.js
    if ! command -v node &> /dev/null; then
        echo -e "  ${YELLOW}⚠${NC} Node.js not found (optional, will try npm)"
    else
        node_version=$(node --version 2>&1)
        echo -e "  ${GREEN}✓${NC} Node.js $node_version"
    fi

    # Check npm
    if ! command -v npm &> /dev/null; then
        echo -e "  ${YELLOW}⚠${NC} npm not found (will use Python fallback)"
    else
        npm_version=$(npm --version 2>&1)
        echo -e "  ${GREEN}✓${NC} npm $npm_version"
    fi

    # Check Rust
    if ! command -v cargo &> /dev/null; then
        echo -e "  ${BLUE}ℹ${NC} Rust not found (will be installed for Crypto-POW module)"
    else
        rust_version=$(rustc --version 2>&1 | awk '{print $2}')
        echo -e "  ${GREEN}✓${NC} Rust $rust_version"
    fi

    # Check if PEP 668 environment
    if python3 -c "import sys; sys.exit(0 if any(p.exists() for p in [__import__('pathlib').Path(f'/usr/lib/python{sys.version_info.major}.{sys.version_info.minor}/EXTERNALLY-MANAGED'), __import__('pathlib').Path('/usr/lib/python3.11/EXTERNALLY-MANAGED')]) else 1)" 2>/dev/null; then
        echo -e "  ${BLUE}ℹ${NC} PEP 668 environment detected (venv will be created)"
    fi

    # Check for existing Claude installation
    if command -v claude &> /dev/null; then
        claude_path=$(which claude)
        echo -e "  ${BLUE}ℹ${NC} Existing Claude found at: $claude_path"
    fi

    # Check if installer exists
    if [[ ! -f "$INSTALLER_SCRIPT" ]]; then
        echo -e "  ${RED}✗${NC} Installer script not found: $INSTALLER_SCRIPT"
        missing+=("installer-script")
    else
        echo -e "  ${GREEN}✓${NC} Installer script found"
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo ""
        echo -e "${RED}Missing prerequisites: ${missing[*]}${NC}"
        echo ""
        echo "To install missing components:"
        for item in "${missing[@]}"; do
            case $item in
                python3)
                    echo "  sudo apt-get update && sudo apt-get install python3 python3-venv python3-pip"
                    ;;
                installer-script)
                    echo "  Ensure you're in the claude-backups directory"
                    ;;
            esac
        done
        return 1
    fi

    echo ""
    return 0
}

# 40+ TFLOPS military optimization (now default)
run_military_optimization() {
    echo -e "${CYAN}Initiating military-grade 40+ TFLOPS optimization...${NC}"
    echo ""

    # Run military hardware detection
    if [[ -f "$SCRIPT_DIR/hardware/milspec_hardware_analyzer.py" ]]; then
        echo -e "${BLUE}Running military hardware analysis...${NC}"
        python3 "$SCRIPT_DIR/hardware/milspec_hardware_analyzer.py"
    fi

    # Execute 40+ TFLOPS optimization
    if [[ -f "$SCRIPT_DIR/execute_40tflops_optimization.sh" ]]; then
        echo -e "${BLUE}Executing 40+ TFLOPS optimization...${NC}"
        bash "$SCRIPT_DIR/execute_40tflops_optimization.sh"
    elif [[ -f "$SCRIPT_DIR/archive/scripts/execute_40tflops_optimization.sh" ]]; then
        echo -e "${BLUE}Executing 40+ TFLOPS optimization...${NC}"
        bash "$SCRIPT_DIR/archive/scripts/execute_40tflops_optimization.sh"
    fi

    # Deploy agent coordination
    if [[ -f "$SCRIPT_DIR/installers/claude/dsmil_orchestrator.py" ]]; then
        echo -e "${BLUE}Deploying 98-agent coordination matrix...${NC}"
        python3 "$SCRIPT_DIR/installers/claude/dsmil_orchestrator.py" || true
    fi

    echo -e "${GREEN}Military optimization complete!${NC}"
}

# Quick install mode (now includes military optimization by default)
quick_install() {
    echo -e "${CYAN}Starting military installation...${NC}"
    echo ""

    # Run enhanced installer with military mode
    python3 "$INSTALLER_SCRIPT" --mode full "$@"

    # Integrate military optimization by default
    echo ""
    echo -e "${YELLOW}Deploying military optimization...${NC}"
    run_military_optimization
}

# Interactive mode
interactive_install() {
    echo -e "${CYAN}Interactive Installation${NC}"
    echo ""
    echo "Choose installation options:"
    echo "  1) Military mode (Default - Recommended)"
    echo "  2) Military + Local Opus (infrastructure-only, use qwen for inference)"
    echo "  3) Force reinstall (overwrites existing)"
    echo "  4) Recreate virtual environment"
    echo "  5) Legacy mode (no military optimization)"
    echo "  6) External API only (no local Opus)"
    echo "  7) Custom (specify options)"
    echo ""
    read -p "Select option (1-7): " choice

    case $choice in
        1)
            quick_install --mode full
            ;;
        2)
            echo -e "${CYAN}Military + Local Opus Infrastructure Installation${NC}"
            echo -e "${YELLOW}Note: Infrastructure-only, use qwen-openvino for actual inference${NC}"
            quick_install --mode full --local-opus
            ;;
        3)
            quick_install --recreate-venv
            ;;
        4)
            quick_install --recreate-venv
            ;;
        5)
            echo -e "${YELLOW}Legacy mode (no military optimization)${NC}"
            python3 "$INSTALLER_SCRIPT" --legacy-mode "$@"
            ;;
        6)
            echo -e "${YELLOW}External API only (no local Opus)${NC}"
            python3 "$INSTALLER_SCRIPT" --external-api-only "$@"
            run_military_optimization
            ;;
        7)
            read -p "Enter custom options: " custom_opts
            quick_install $custom_opts
            ;;
        *)
            echo -e "${RED}Invalid option${NC}"
            exit 1
            ;;
    esac
}

# Show help
show_help() {
    cat << EOF
Usage: $0 [OPTIONS]

Quick installer for Claude with virtual environment support.

OPTIONS:
    -h, --help          Show this help message
    -q, --quick         Quick install with defaults
    -f, --force         Force reinstallation
    -r, --recreate      Recreate virtual environment
    -i, --interactive   Interactive installation mode
    --skip-npm          Skip npm installation attempt
    --no-color          Disable colored output
    --legacy-mode       Disable military optimization (legacy)
    --external-api      Skip local Opus deployment
    --cpu-only          Skip NPU optimization

EXAMPLES:
    $0                  # Default: Military + Local Opus
    $0 --legacy-mode    # Traditional installation only
    $0 --force          # Force reinstall everything
    $0 --interactive    # Choose options interactively
    $0 --external-api   # Military optimization without local Opus

ENVIRONMENT:
    The installer will (by default):
    - Create virtual environment at ~/.claude-venv
    - Install Claude via npm (with sudo if needed)
    - Deploy 40+ TFLOPS military optimization
    - Set up local Opus inference (token-free)
    - Configure 98-agent coordination system
    - Enable NPU military mode (26.4 TOPS)
    - Update shell configuration
    - Create wrapper scripts in ~/.local/bin

NOTES:
    For Debian 12/Ubuntu 23+ with PEP 668, a virtual environment
    is automatically created to bypass system Python restrictions.

EOF
}

# Post-installation message
post_install_message() {
    echo ""
    echo "======================================================================"
    echo -e "${GREEN}Installation Complete!${NC}"
    echo "======================================================================"
    echo ""

    # Setup binaries automatically
    if [[ -f "$SCRIPT_DIR/scripts/setup-binaries.sh" ]]; then
        echo -e "${CYAN}Setting up binary shortcuts...${NC}"
        bash "$SCRIPT_DIR/scripts/setup-binaries.sh" 2>/dev/null || true
        echo ""
    fi

    echo -e "${BOLD}To run Claude, you may need to reload your shell configuration:${NC}"
    echo -e "   ${CYAN}source ~/.bashrc${NC}  (or ~/.zshrc, ~/.profile, etc., depending on your shell)"
    echo ""
    echo -e "${BOLD}Then, you can test Claude:${NC}"
    echo -e "   ${CYAN}claude --version${NC}"
    echo ""
    echo -e "${BOLD}Quick commands:${NC}"
    echo "  1. Validate system:"
    echo -e "     ${CYAN}./scripts/quick-validate.sh${NC}"
    echo ""
    echo "  2. Run benchmarks:"
    echo -e "     ${CYAN}./scripts/quick-bench.sh${NC}"
    echo ""
    echo "  3. Load convenience aliases:"
    echo -e "     ${CYAN}source scripts/shell-aliases.sh${NC}"
    echo ""
    echo "  4. Check agent system:"
    echo -e "     ${CYAN}ls -la ~/.claude/${NC}"
    echo ""
    echo -e "${BLUE}For help: claude --help${NC}"
    echo -e "${BLUE}Quick start guide: cat QUICKSTART.md${NC}"
    echo "======================================================================"
}

# Main logic
main() {
    # Parse arguments
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -i|--interactive)
            print_banner
            if check_prerequisites; then
                interactive_install
                post_install_message
            fi
            ;;
        -q|--quick)
            print_banner
            if check_prerequisites; then
                quick_install "${@:2}"
                post_install_message
            fi
            ;;
        -f|--force)
            print_banner
            if check_prerequisites; then
                quick_install --force "${@:2}"
                post_install_message
            fi
            ;;
        -r|--recreate)
            print_banner
            if check_prerequisites; then
                quick_install --recreate-venv "${@:2}"
                post_install_message
            fi
            ;;
        --skip-npm)
            print_banner
            if check_prerequisites; then
                quick_install --skip-npm "${@:2}"
                post_install_message
            fi
            ;;
        --no-color)
            # Disable colors
            RED=''; GREEN=''; YELLOW=''; BLUE=''; CYAN=''; BOLD=''; NC=''
            print_banner
            if check_prerequisites; then
                quick_install --no-color "${@:2}"
                post_install_message
            fi
            ;;
        --legacy-mode)
            print_banner
            if check_prerequisites; then
                echo -e "${YELLOW}Legacy mode installation (no military optimization)${NC}"
                python3 "$INSTALLER_SCRIPT" --legacy-mode "${@:2}"
                post_install_message
            fi
            ;;
        --external-api)
            print_banner
            if check_prerequisites; then
                echo -e "${YELLOW}External API mode (military optimization without local Opus)${NC}"
                python3 "$INSTALLER_SCRIPT" --external-api-only "${@:2}"
                run_military_optimization
                post_install_message
            fi
            ;;
        --cpu-only)
            print_banner
            if check_prerequisites; then
                echo -e "${YELLOW}CPU-only mode (no NPU optimization)${NC}"
                python3 "$INSTALLER_SCRIPT" --cpu-only "${@:2}"
                post_install_message
            fi
            ;;
        *)
            # Default: Military + Local Opus installation
            print_banner
            install_dependencies
            if check_prerequisites; then
                quick_install "$@"
                # Set ownership of the claude wrapper to the current user (if running with sudo)
                if [[ -f "$HOME/.local/bin/claude" ]] && [[ $EUID -eq 0 ]]; then
                    chown "$USER":"$USER" "$HOME/.local/bin/claude" 2>/dev/null || true
                fi
                post_install_message
            fi
            ;;
    esac
}

# Error handler
trap 'echo -e "\n${RED}Installation failed. Check the error messages above.${NC}"; exit 1' ERR

# Run main
main "$@"