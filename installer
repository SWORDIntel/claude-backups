#!/bin/bash
# Claude Quick Installer - Intelligent wrapper for claude-enhanced-installer-venv.py
# Automatically detects and handles various installation scenarios

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INSTALLER_SCRIPT="$SCRIPT_DIR/installers/claude/claude-enhanced-installer.py"

# Banner
print_banner() {
    echo "======================================================================"
    echo -e "${BOLD}Claude Quick Installer v1.0${NC}"
    echo "Intelligent installation with PEP 668 virtual environment support"
    echo "======================================================================"
    echo ""
}

# Install all system dependencies
install_dependencies() {
    echo ""
    echo -e "${CYAN}Installing system dependencies...${NC}"
    echo ""

    DEPS=(
        "build-essential"
        "gcc-15" "g++-15"
        "python3-full" "python3-pip" "python3-venv" "python-is-python3"
        "libnuma-dev" "liburing-dev" "librdkafka-dev"
        "libssl-dev" "libpcre2-dev"
        "docker.io"
        "curl" "wget" "git"
    )

    echo "The following packages will be installed:"
    printf '  - %s\n' "${DEPS[@]}"
    echo ""

    echo -e "${YELLOW}You will be prompted for your sudo password.${NC}"
    echo "1786" | sudo -S apt-get update
    echo "1786" | sudo -S apt-get install -y "${DEPS[@]}"

    echo ""

    # Install Rust toolchain if not present
    if ! command -v cargo &> /dev/null; then
        echo -e "${CYAN}Installing Rust toolchain...${NC}"
        echo -e "${YELLOW}This may take 2-3 minutes...${NC}"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env" 2>/dev/null || export PATH="$HOME/.cargo/bin:$PATH"
        echo -e "  ${GREEN}✓${NC} Rust installed"
    else
        echo -e "  ${GREEN}✓${NC} Rust already installed"
    fi

    # Add user to docker group
    if groups | grep -q docker; then
        echo -e "  ${GREEN}✓${NC} User already in docker group"
    else
        echo -e "${CYAN}Adding user to docker group...${NC}"
        echo "1786" | sudo -S usermod -aG docker "$USER"
        echo -e "  ${YELLOW}⚠${NC} You may need to logout/login for docker group to take effect"
    fi

    echo ""
}

# Check prerequisites
check_prerequisites() {
    local missing=()

    echo -e "${CYAN}Checking prerequisites...${NC}"

    # Check Python
    if ! command -v python3 &> /dev/null; then
        missing+=("python3")
    else
        python_version=$(python3 --version 2>&1 | awk '{print $2}')
        echo -e "  ${GREEN}✓${NC} Python $python_version"
    fi

    # Check Node.js
    if ! command -v node &> /dev/null; then
        echo -e "  ${YELLOW}⚠${NC} Node.js not found (optional, will try npm)"
    else
        node_version=$(node --version 2>&1)
        echo -e "  ${GREEN}✓${NC} Node.js $node_version"
    fi

    # Check npm
    if ! command -v npm &> /dev/null; then
        echo -e "  ${YELLOW}⚠${NC} npm not found (will use Python fallback)"
    else
        npm_version=$(npm --version 2>&1)
        echo -e "  ${GREEN}✓${NC} npm $npm_version"
    fi

    # Check if PEP 668 environment
    if python3 -c "import sys; sys.exit(0 if any(p.exists() for p in [__import__('pathlib').Path(f'/usr/lib/python{sys.version_info.major}.{sys.version_info.minor}/EXTERNALLY-MANAGED'), __import__('pathlib').Path('/usr/lib/python3.11/EXTERNALLY-MANAGED')]) else 1)" 2>/dev/null; then
        echo -e "  ${BLUE}ℹ${NC} PEP 668 environment detected (venv will be created)"
    fi

    # Check for existing Claude installation
    if command -v claude &> /dev/null; then
        claude_path=$(which claude)
        echo -e "  ${BLUE}ℹ${NC} Existing Claude found at: $claude_path"
    fi

    # Check if installer exists
    if [[ ! -f "$INSTALLER_SCRIPT" ]]; then
        echo -e "  ${RED}✗${NC} Installer script not found: $INSTALLER_SCRIPT"
        missing+=("installer-script")
    else
        echo -e "  ${GREEN}✓${NC} Installer script found"
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo ""
        echo -e "${RED}Missing prerequisites: ${missing[*]}${NC}"
        echo ""
        echo "To install missing components:"
        for item in "${missing[@]}"; do
            case $item in
                python3)
                    echo "  sudo apt-get update && sudo apt-get install python3 python3-venv python3-pip"
                    ;;
                installer-script)
                    echo "  Ensure you're in the claude-backups directory"
                    ;;
            esac
        done
        return 1
    fi

    echo ""
    return 0
}

# Quick install mode
quick_install() {
    echo -e "${CYAN}Starting quick installation...${NC}"
    echo ""
    python3 "$INSTALLER_SCRIPT" "$@"
}

# Interactive mode
interactive_install() {
    echo -e "${CYAN}Interactive Installation${NC}"
    echo ""
    echo "Choose installation options:"
    echo "  1) Standard install"
    echo "  2) Force reinstall (overwrites existing)"
    echo "  3) Recreate virtual environment"
    echo "  4) Skip npm (Python-only)"
    echo "  5) Custom (specify options)"
    echo ""
    read -p "Select option (1-5): " choice

    case $choice in
        1)
            quick_install
            ;;
        2)
            quick_install --force
            ;;
        3)
            quick_install --recreate-venv
            ;;
        4)
            quick_install --skip-npm
            ;;
        5)
            read -p "Enter custom options: " custom_opts
            quick_install $custom_opts
            ;;
        *)
            echo -e "${RED}Invalid option${NC}"
            exit 1
            ;;
    esac
}

# Show help
show_help() {
    cat << EOF
Usage: $0 [OPTIONS]

Quick installer for Claude with virtual environment support.

OPTIONS:
    -h, --help          Show this help message
    -q, --quick         Quick install with defaults
    -f, --force         Force reinstallation
    -r, --recreate      Recreate virtual environment
    -i, --interactive   Interactive installation mode
    --skip-npm          Skip npm installation attempt
    --no-color          Disable colored output

EXAMPLES:
    $0                  # Default quick installation
    $0 --quick          # Explicit quick mode
    $0 --force          # Force reinstall everything
    $0 --interactive    # Choose options interactively

ENVIRONMENT:
    The installer will:
    - Create virtual environment at ~/.claude-venv
    - Install Claude via npm (with sudo if needed)
    - Set up agent orchestration system
    - Update shell configuration
    - Create wrapper scripts in ~/.local/bin

NOTES:
    For Debian 12/Ubuntu 23+ with PEP 668, a virtual environment
    is automatically created to bypass system Python restrictions.

EOF
}

# Post-installation message
post_install_message() {
    echo ""
    echo "======================================================================"
    echo -e "${GREEN}Installation Complete!${NC}"
    echo "======================================================================"
    echo ""
    echo -e "${BOLD}Next steps:${NC}"
    echo "1. Reload your shell configuration:"
    echo -e "   ${CYAN}source ~/.bashrc${NC}"
    echo ""
    echo "2. Test Claude:"
    echo -e "   ${CYAN}claude --version${NC}"
    echo ""
    echo "3. Activate virtual environment (if needed):"
    echo -e "   ${CYAN}claude-activate${NC}"
    echo ""
    echo "4. Check agent system:"
    echo -e "   ${CYAN}ls -la ~/.claude/${NC}"
    echo ""
    echo -e "${BLUE}For help: claude --help${NC}"
    echo "======================================================================"
}

# Main logic
main() {
    # Parse arguments
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -i|--interactive)
            print_banner
            if check_prerequisites; then
                interactive_install
                post_install_message
            fi
            ;;
        -q|--quick)
            print_banner
            if check_prerequisites; then
                quick_install "${@:2}"
                post_install_message
            fi
            ;;
        -f|--force)
            print_banner
            if check_prerequisites; then
                quick_install --force "${@:2}"
                post_install_message
            fi
            ;;
        -r|--recreate)
            print_banner
            if check_prerequisites; then
                quick_install --recreate-venv "${@:2}"
                post_install_message
            fi
            ;;
        --skip-npm)
            print_banner
            if check_prerequisites; then
                quick_install --skip-npm "${@:2}"
                post_install_message
            fi
            ;;
        --no-color)
            # Disable colors
            RED=''; GREEN=''; YELLOW=''; BLUE=''; CYAN=''; BOLD=''; NC=''
            print_banner
            if check_prerequisites; then
                quick_install --no-color "${@:2}"
                post_install_message
            fi
            ;;
        *)
            # Default: quick install with dependencies
            print_banner
            install_dependencies
            if check_prerequisites; then
                quick_install "$@"
                post_install_message
            fi
            ;;
    esac
}

# Error handler
trap 'echo -e "\n${RED}Installation failed. Check the error messages above.${NC}"; exit 1' ERR

# Run main
main "$@"