#!/bin/bash
# ============================================================================
# Claude Code - LiveCD Launcher with Options
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_BIN="${SCRIPT_DIR}/claude"

# Function to setup environment
setup_environment() {
    export PATH="${SCRIPT_DIR}:${SCRIPT_DIR}/gh-cli:${PATH}"
    export GH_CONFIG_DIR="${SCRIPT_DIR}/.config/gh"
    
    # Create Claude config directory
    export CLAUDE_HOME="${SCRIPT_DIR}/.claude-home"
    export CLAUDE_CONFIG_DIR="${CLAUDE_HOME}/.config/claude"
    mkdir -p "$CLAUDE_CONFIG_DIR"
    
    # Link agents
    ln -sf "${SCRIPT_DIR}/agents" "$CLAUDE_CONFIG_DIR/agents" 2>/dev/null
}

# Function to run Claude directly
run_claude_direct() {
    setup_environment
    
    echo "═══════════════════════════════════════════════════════════"
    echo "     CLAUDE CODE - Direct Launch Mode"
    echo "═══════════════════════════════════════════════════════════"
    echo ""
    echo "Claude CLI: ${CLAUDE_BIN}"
    echo "Agents directory: ${SCRIPT_DIR}/agents"
    echo "GitHub CLI: ${SCRIPT_DIR}/gh-cli/gh"
    echo ""
    echo "Environment configured for LiveCD:"
    echo "  - Claude runs with --dangerously-skip-permissions"
    echo "  - All data stored in: ${SCRIPT_DIR}"
    echo "  - No system modifications"
    echo ""
    
    if [ -x "$CLAUDE_BIN" ]; then
        echo "Starting Claude Code..."
        echo "Running: claude --dangerously-skip-permissions $@"
        echo ""
        exec "$CLAUDE_BIN" --dangerously-skip-permissions "$@"
    else
        echo "ERROR: Claude binary not found at $CLAUDE_BIN"
        echo "Starting shell with environment configured..."
        echo "You can manually run: ./claude --dangerously-skip-permission-check"
        exec bash
    fi
}

# Function to run quick install
run_quick_install() {
    echo "Starting quick installation..."
    if [ -f "${SCRIPT_DIR}/scripts/claude-quick-launch-agents.sh" ]; then
        cd "${SCRIPT_DIR}/scripts"
        chmod +x claude-quick-launch-agents.sh
        exec ./claude-quick-launch-agents.sh
    else
        echo "ERROR: Quick install script not found"
        exit 1
    fi
}

# Function to run custom install
run_custom_install() {
    echo "Starting custom installation..."
    if [ -f "${SCRIPT_DIR}/scripts/claude-livecd-unified-with-agents.sh" ]; then
        cd "${SCRIPT_DIR}/scripts"
        chmod +x claude-livecd-unified-with-agents.sh
        exec ./claude-livecd-unified-with-agents.sh
    else
        echo "ERROR: Custom install script not found"
        exit 1
    fi
}

# Function to view documentation
view_documentation() {
    if [ -f "${SCRIPT_DIR}/docs/README.md" ]; then
        if command -v less >/dev/null 2>&1; then
            less "${SCRIPT_DIR}/docs/README.md"
        else
            cat "${SCRIPT_DIR}/docs/README.md"
        fi
    else
        echo "Documentation not found at ${SCRIPT_DIR}/docs/README.md"
    fi
    echo ""
    echo "Press Enter to return to menu..."
    read
    show_menu
}

# Function to show menu
show_menu() {
    cat << 'ASCII'
   _____ _                 _        _____          _      
  / ____| |               | |      / ____|        | |     
 | |    | | __ _ _   _  __| | ___ | |     ___   __| | ___ 
 | |    | |/ _` | | | |/ _` |/ _ \| |    / _ \ / _` |/ _ \
 | |____| | (_| | |_| | (_| |  __/| |___| (_) | (_| |  __/
  \_____|_|\__,_|\__,_|\__,_|\___| \_____\___/ \__,_|\___|
                                                           
            Intel Core Ultra 7 Optimized Edition          
ASCII

    echo ""
    echo "Welcome to Claude Code - LiveCD Edition"
    echo "========================================"
    echo ""
    echo "Choose an option:"
    echo ""
    echo "1) Launch Claude Code (Direct)"
    echo "2) Quick Install (Recommended) - Fully automatic"
    echo "3) Custom Install - With options"
    echo "4) View Documentation"
    echo "5) Exit"
    echo ""
    read -p "Enter your choice [1-5]: " choice
    
    case $choice in
        1)
            run_claude_direct "$@"
            ;;
        2)
            run_quick_install
            ;;
        3)
            run_custom_install
            ;;
        4)
            view_documentation
            ;;
        5)
            echo "Exiting Claude Code."
            exit 0
            ;;
        *)
            echo "Invalid choice. Please try again."
            echo ""
            show_menu "$@"
            ;;
    esac
}

# Main execution
if [ "$1" == "--direct" ] || [ "$1" == "-d" ]; then
    # Skip menu and run directly
    shift
    run_claude_direct "$@"
elif [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
    echo "Claude Code - LiveCD Launcher"
    echo ""
    echo "Usage: ./claude-code [OPTIONS] [CLAUDE_ARGS]"
    echo ""
    echo "Options:"
    echo "  --direct, -d    Launch Claude directly without menu"
    echo "  --help, -h      Show this help message"
    echo ""
    echo "Without options, shows interactive menu"
    echo ""
    echo "Examples:"
    echo "  ./claude-code           # Show interactive menu"
    echo "  ./claude-code --direct  # Launch Claude directly"
    echo "  ./claude-code -d chat   # Launch Claude in chat mode"
    exit 0
else
    # Show interactive menu
    show_menu "$@"
fi