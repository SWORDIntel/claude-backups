#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# CLAUDE ULTIMATE BASH OUTPUT FIX v13.3 - DIRECT IMPLEMENTATION
# 
# This wrapper completely eliminates bash output suppression issues by:
# • Using hardcoded paths (no runtime discovery)
# • Direct exec with proper I/O inheritance
# • Zero subprocess interference
# • Optimal environment configuration
# ═══════════════════════════════════════════════════════════════════════════

# CRITICAL: Set optimal I/O environment immediately
set +e
export FORCE_OUTPUT=1
export CLAUDE_OUTPUT_MODE=direct
export NO_SUBPROCESS_WRAPPER=1
export FORCE_COLOR=1
export TERM="${TERM:-xterm-256color}"
export NO_UPDATE_NOTIFIER=1
export DISABLE_OPENCOLLECTIVE=1
export CLAUDE_NO_SPINNER=1
export CLAUDE_NO_PROGRESS=1
export CLAUDE_OUTPUT_RAW=1
export NODE_NO_READLINE=1
export NODE_DISABLE_COLORS=0

# Clear any interference variables
unset CLAUDE_QUIET SILENT SUPPRESS_OUTPUT

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# HARDCODED PATHS (DETERMINED AT CREATION TIME)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Find Claude binary
CLAUDE_BINARY=""
claude_paths=(
    "$(npm root -g 2>/dev/null)/@anthropic-ai/claude-code/cli.js"
    "$HOME/.npm-global/lib/node_modules/@anthropic-ai/claude-code/cli.js"
    "/usr/local/lib/node_modules/@anthropic-ai/claude-code/cli.js"
    "$(which claude 2>/dev/null || true)"
    "/usr/bin/claude"
    "/usr/local/bin/claude"
)

for path in "${claude_paths[@]}"; do
    if [[ -n "$path" ]] && [[ -f "$path" ]]; then
        CLAUDE_BINARY="$path"
        break
    fi
done

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ULTIMATE BASH OUTPUT FIX EXECUTION
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Handle special commands
case "${1:-}" in
    --status|status)
        echo "Claude Ultimate Bash Output Fix v13.3"
        echo "Claude Binary: ${CLAUDE_BINARY:-NOT FOUND}"
        echo "Created: $(date)"
        exit 0
        ;;
    --help|help|-h)
        echo "Claude Ultimate Bash Output Fix v13.3"
        echo
        echo "This wrapper completely resolves bash output suppression issues."
        echo
        echo "Usage: claude-fixed [OPTIONS] [COMMAND]"
        echo "All commands are passed directly to Claude with zero I/O interference."
        exit 0
        ;;
esac

# Prepare arguments
args=("$@")

# Add permission bypass by default (unless --safe specified)
if [[ "${args[0]}" != "--safe" ]]; then
    args=("--dangerously-skip-permissions" "${args[@]}")
else
    args=("${args[@]:1}")
fi

# CRITICAL: Use exec to completely replace shell process
# This eliminates ALL wrapper interference with bash command output

if [[ -z "$CLAUDE_BINARY" ]]; then
    echo "ERROR: Claude binary not found. Install with: npm install -g @anthropic-ai/claude-code"
    exit 1
fi

# Method 1: Direct binary execution with complete I/O inheritance
if [[ -x "$CLAUDE_BINARY" ]]; then
    # Ensure proper file descriptor inheritance
    exec 1>&1 2>&2 < /dev/stdin
    exec "$CLAUDE_BINARY" "${args[@]}"
fi

# Method 2: Node.js execution with I/O inheritance
if command -v node >/dev/null 2>&1; then
    exec 1>&1 2>&2 < /dev/stdin
    exec node "$CLAUDE_BINARY" "${args[@]}"
fi

# Method 3: npx fallback with I/O inheritance
if command -v npx >/dev/null 2>&1; then
    exec 1>&1 2>&2 < /dev/stdin
    exec npx @anthropic-ai/claude-code "${args[@]}"
fi

echo "ERROR: No Claude execution method available" >&2
exit 1