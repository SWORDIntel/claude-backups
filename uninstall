#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# Claude Uninstaller Shortcut
# Comprehensive uninstaller for all Claude components
# ═══════════════════════════════════════════════════════════════════════════

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

# Print header
echo -e "${BOLD}${RED}Claude Comprehensive Uninstaller${RESET}"
echo -e "${YELLOW}This will remove all Claude Code installations and related components${RESET}"
echo

# Confirmation
read -p "Are you sure you want to uninstall Claude Code? [y/N]: " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${CYAN}Uninstall cancelled.${RESET}"
    exit 0
fi

echo -e "${YELLOW}Starting comprehensive uninstall...${RESET}"
echo

# Function to safely remove file/directory
safe_remove() {
    local target="$1"
    local description="$2"

    if [[ -e "$target" ]]; then
        echo -e "${YELLOW}Removing $description: $target${RESET}"
        rm -rf "$target" 2>/dev/null || {
            echo -e "${RED}Failed to remove: $target${RESET}"
            return 1
        }
        echo -e "${GREEN}✓ Removed: $description${RESET}"
    else
        echo -e "${CYAN}✓ Not found: $description${RESET}"
    fi
}

# 1. Remove npm installations
echo -e "${BOLD}${CYAN}1. Removing npm installations...${RESET}"
if command -v npm >/dev/null 2>&1; then
    npm uninstall -g @anthropic-ai/claude-code 2>/dev/null || true
    npm uninstall -g claude-code 2>/dev/null || true
    echo -e "${GREEN}✓ npm packages removed${RESET}"
else
    echo -e "${CYAN}✓ npm not found${RESET}"
fi
echo

# 2. Remove pip installations
echo -e "${BOLD}${CYAN}2. Removing pip installations...${RESET}"
if command -v pip3 >/dev/null 2>&1; then
    pip3 uninstall claude-code -y 2>/dev/null || true
    pip3 uninstall anthropic-claude-code -y 2>/dev/null || true
    echo -e "${GREEN}✓ pip packages removed${RESET}"
else
    echo -e "${CYAN}✓ pip not found${RESET}"
fi
echo

# 3. Remove binaries and wrappers
echo -e "${BOLD}${CYAN}3. Removing binaries and wrappers...${RESET}"
safe_remove "$HOME/.local/bin/claude" "Local claude binary"
safe_remove "/usr/local/bin/claude" "System claude binary"
safe_remove "$HOME/.npm-global/bin/claude" "npm global claude binary"
safe_remove "$HOME/.local/bin/python-orchestrator" "Python orchestrator"
safe_remove "$HOME/.local/bin/claude-agent" "Claude agent bridge"
echo

# 4. Remove configuration and data
echo -e "${BOLD}${CYAN}4. Removing configuration and data...${RESET}"
safe_remove "$HOME/.claude-home" "Claude home directory"
safe_remove "$HOME/.config/claude" "Claude configuration"
safe_remove "$HOME/agents" "Agents directory"
safe_remove "$HOME/.claude" "Claude project directory"
echo

# 5. Remove node modules
echo -e "${BOLD}${CYAN}5. Removing node modules...${RESET}"
safe_remove "$HOME/.npm-global/lib/node_modules/@anthropic-ai/claude-code" "Claude Code node module"
safe_remove "/usr/local/lib/node_modules/@anthropic-ai/claude-code" "System Claude Code node module"
echo

# 6. Remove learning system and database
echo -e "${BOLD}${CYAN}6. Removing learning system and database...${RESET}"
if command -v docker >/dev/null 2>&1; then
    echo -e "${YELLOW}Stopping and removing Docker containers...${RESET}"

    # Check Docker permissions
    if docker ps >/dev/null 2>&1; then
        docker stop claude-postgres claude-learning claude-bridge 2>/dev/null || true
        docker rm claude-postgres claude-learning claude-bridge 2>/dev/null || true
        docker volume rm claude-postgres-data claude-learning-data 2>/dev/null || true
        echo -e "${GREEN}✓ Docker containers and volumes removed${RESET}"
    else
        echo -e "${YELLOW}Docker permission issue detected. You may need to run:${RESET}"
        echo -e "${CYAN}  sudo usermod -aG docker \$USER${RESET}"
        echo -e "${CYAN}  newgrp docker${RESET}"
        echo -e "${YELLOW}Or use sudo for Docker commands:${RESET}"
        echo -e "${CYAN}  sudo docker stop claude-postgres claude-learning claude-bridge${RESET}"
        echo -e "${CYAN}  sudo docker rm claude-postgres claude-learning claude-bridge${RESET}"
        echo -e "${CYAN}  sudo docker volume rm claude-postgres-data claude-learning-data${RESET}"
    fi
else
    echo -e "${CYAN}✓ Docker not found${RESET}"
fi
echo

# 7. Remove project-specific files (optional)
read -p "Remove project files and agents? [y/N]: " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${BOLD}${CYAN}7. Removing project files...${RESET}"
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    # Only remove specific files, not the entire project
    safe_remove "$SCRIPT_DIR/claude-python-installer.sh" "Python installer"
    safe_remove "$SCRIPT_DIR/claude-enhanced-installer.py" "Enhanced installer"
    safe_remove "$SCRIPT_DIR/upgrade-to-python-installer.py" "Upgrade installer"
    safe_remove "$SCRIPT_DIR/.claude" "Project Claude directory"

    echo -e "${YELLOW}Note: Main project files preserved. Only installer components removed.${RESET}"
else
    echo -e "${CYAN}Project files preserved.${RESET}"
fi
echo

# 8. Clean environment variables
echo -e "${BOLD}${CYAN}8. Cleaning environment variables...${RESET}"
echo -e "${YELLOW}Note: Please manually remove Claude-related environment variables from:${RESET}"
echo -e "${CYAN}  • ~/.bashrc${RESET}"
echo -e "${CYAN}  • ~/.zshrc${RESET}"
echo -e "${CYAN}  • ~/.profile${RESET}"
echo -e "${CYAN}  • ~/.bash_profile${RESET}"
echo

# Final status
echo -e "${BOLD}${GREEN}═══════════════════════════════════════════════════════════════════════════${RESET}"
echo -e "${BOLD}${GREEN}Claude Code Uninstall Complete${RESET}"
echo -e "${BOLD}${GREEN}═══════════════════════════════════════════════════════════════════════════${RESET}"
echo
echo -e "${CYAN}To verify removal, try running: claude --version${RESET}"
echo -e "${CYAN}If command is not found, uninstall was successful.${RESET}"
echo
echo -e "${YELLOW}Note: Some shell sessions may need to be restarted to clear cached commands.${RESET}"