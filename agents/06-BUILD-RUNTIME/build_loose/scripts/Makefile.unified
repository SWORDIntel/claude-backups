# Simplified Unified Makefile for Claude Agent Communication System
# Focus on working build with portable dependencies

CC = gcc
AR = ar
RANLIB = ranlib

# Basic flags
CFLAGS = -std=c11 -Wall -Wextra -Wpedantic -Wno-unused-parameter
CFLAGS += -D_GNU_SOURCE -DVERSION=\"1.0.0\"
CFLAGS += -O2 -DNDEBUG -fomit-frame-pointer
CFLAGS += -DHAVE_PTHREADS=1 -DHAVE_NUMA=0 -DHAVE_LIBURING=0

# Architecture detection
ARCH := $(shell uname -m)
ifeq ($(ARCH),x86_64)
    CFLAGS += -m64 -msse2 -msse4.2 -mavx -mavx2
endif

LDFLAGS = -lpthread -lrt -lm -ldl

# Source files that we know compile
COMPAT_SOURCES = compatibility_layer.c
PROTOCOL_SOURCES = ultra_hybrid_enhanced.c
TEST_SOURCES = build_test.c

# Object files
COMPAT_OBJS = compatibility_layer.o
PROTOCOL_OBJS = agent_bridge.o
TEST_OBJS = build_test.o

# Libraries
STATIC_LIB = libclaude-agents.a
SHARED_LIB = libclaude-agents.so.1.0.0

# Executables
EXECUTABLES = claude-transport-test claude-protocol-benchmark build-test

.PHONY: all clean libs test

all: libs $(EXECUTABLES)

# Generate compatibility layer
compatibility_layer.h:
	@echo "=== Generating Compatibility Layer Header ==="
	@echo "/* Simplified compatibility layer */" > compatibility_layer.h
	@echo "#ifndef COMPATIBILITY_LAYER_H" >> compatibility_layer.h
	@echo "#define COMPATIBILITY_LAYER_H" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "#include <stdint.h>" >> compatibility_layer.h
	@echo "#include <stdbool.h>" >> compatibility_layer.h
	@echo "#include <stdlib.h>" >> compatibility_layer.h
	@echo "#include <unistd.h>" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "/* NUMA compatibility stubs */" >> compatibility_layer.h
	@echo "#define numa_available() -1" >> compatibility_layer.h
	@echo "#define numa_max_node() 0" >> compatibility_layer.h
	@echo "#define numa_num_configured_nodes() 1" >> compatibility_layer.h
	@echo "#define numa_node_of_cpu(cpu) 0" >> compatibility_layer.h
	@echo "#define numa_alloc_onnode(size, node) malloc(size)" >> compatibility_layer.h
	@echo "#define numa_free(ptr, size) free(ptr)" >> compatibility_layer.h
	@echo "#define numa_alloc_interleaved(size) malloc(size)" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "/* io_uring compatibility stubs */" >> compatibility_layer.h
	@echo "struct io_uring { int dummy; };" >> compatibility_layer.h
	@echo "struct io_uring_sqe { int dummy; };" >> compatibility_layer.h
	@echo "struct io_uring_cqe { int dummy; };" >> compatibility_layer.h
	@echo "#define io_uring_queue_init(entries, ring, flags) -1" >> compatibility_layer.h
	@echo "#define io_uring_queue_exit(ring) do {} while(0)" >> compatibility_layer.h
	@echo "#define io_uring_get_sqe(ring) NULL" >> compatibility_layer.h
	@echo "#define io_uring_prep_read(sqe, fd, buf, len, offset) do {} while(0)" >> compatibility_layer.h
	@echo "#define io_uring_prep_write(sqe, fd, buf, len, offset) do {} while(0)" >> compatibility_layer.h
	@echo "#define io_uring_sqe_set_data(sqe, data) do {} while(0)" >> compatibility_layer.h
	@echo "#define io_uring_submit(ring) -1" >> compatibility_layer.h
	@echo "#define io_uring_wait_cqe(ring, cqe_ptr) -1" >> compatibility_layer.h
	@echo "#define io_uring_peek_cqe(ring, cqe_ptr) -1" >> compatibility_layer.h
	@echo "#define io_uring_cqe_seen(ring, cqe) do {} while(0)" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "/* Function prototypes */" >> compatibility_layer.h
	@echo "int io_uring_fallback_read(int fd, void *buf, size_t count, off_t offset);" >> compatibility_layer.h
	@echo "int io_uring_fallback_write(int fd, const void *buf, size_t count, off_t offset);" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "/* Message protocol structures - only if not already defined */" >> compatibility_layer.h
	@echo "#ifndef ENHANCED_MSG_HEADER_T_DEFINED" >> compatibility_layer.h
	@echo "typedef struct {" >> compatibility_layer.h
	@echo "    uint32_t magic;" >> compatibility_layer.h
	@echo "    uint32_t msg_id;" >> compatibility_layer.h
	@echo "    uint64_t timestamp;" >> compatibility_layer.h
	@echo "    uint32_t payload_len;" >> compatibility_layer.h
	@echo "    uint32_t checksum;" >> compatibility_layer.h
	@echo "    uint16_t source_agent;" >> compatibility_layer.h
	@echo "    uint16_t target_agent;" >> compatibility_layer.h
	@echo "    uint8_t msg_type;" >> compatibility_layer.h
	@echo "    uint8_t priority;" >> compatibility_layer.h
	@echo "    uint8_t flags;" >> compatibility_layer.h
	@echo "    uint8_t ttl;" >> compatibility_layer.h
	@echo "    uint32_t correlation_id;" >> compatibility_layer.h
	@echo "    uint8_t padding1[24];" >> compatibility_layer.h
	@echo "    float ai_confidence;" >> compatibility_layer.h
	@echo "    float anomaly_score;" >> compatibility_layer.h
	@echo "    uint16_t predicted_path[4];" >> compatibility_layer.h
	@echo "    uint64_t feature_hash;" >> compatibility_layer.h
	@echo "    uint8_t gpu_batch_id;" >> compatibility_layer.h
	@echo "    uint8_t padding2[31];" >> compatibility_layer.h
	@echo "} enhanced_msg_header_t;" >> compatibility_layer.h
	@echo "#endif" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "/* Protocol function stubs */" >> compatibility_layer.h
	@echo "int ring_buffer_read_priority(void* rb, int priority, enhanced_msg_header_t* msg, uint8_t* payload);" >> compatibility_layer.h
	@echo "void process_message_pcore(enhanced_msg_header_t* msg, uint8_t* payload);" >> compatibility_layer.h
	@echo "void process_message_ecore(enhanced_msg_header_t* msg, uint8_t* payload);" >> compatibility_layer.h
	@echo "void* work_queue_steal(void* queue);" >> compatibility_layer.h
	@echo "" >> compatibility_layer.h
	@echo "#endif /* COMPATIBILITY_LAYER_H */" >> compatibility_layer.h

compatibility_layer.c: compatibility_layer.h
	@echo "=== Generating Compatibility Layer Implementation ==="
	@echo "/* Simplified compatibility implementation */" > compatibility_layer.c
	@echo "#include \"compatibility_layer.h\"" >> compatibility_layer.c
	@echo "#include <stdio.h>" >> compatibility_layer.c
	@echo "#include <string.h>" >> compatibility_layer.c
	@echo "#include <unistd.h>" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "/* io_uring fallback implementations using regular I/O */" >> compatibility_layer.c
	@echo "int io_uring_fallback_read(int fd, void *buf, size_t count, off_t offset) {" >> compatibility_layer.c
	@echo "    if (lseek(fd, offset, SEEK_SET) == -1) return -1;" >> compatibility_layer.c
	@echo "    return read(fd, buf, count);" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "int io_uring_fallback_write(int fd, const void *buf, size_t count, off_t offset) {" >> compatibility_layer.c
	@echo "    if (lseek(fd, offset, SEEK_SET) == -1) return -1;" >> compatibility_layer.c
	@echo "    return write(fd, buf, count);" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "/* Protocol function stubs */" >> compatibility_layer.c
	@echo "int ring_buffer_read_priority(void* rb, int priority, enhanced_msg_header_t* msg, uint8_t* payload) {" >> compatibility_layer.c
	@echo "    (void)rb; (void)priority; (void)msg; (void)payload;" >> compatibility_layer.c
	@echo "    return 0; /* No messages available */" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "void process_message_pcore(enhanced_msg_header_t* msg, uint8_t* payload) {" >> compatibility_layer.c
	@echo "    (void)msg; (void)payload;" >> compatibility_layer.c
	@echo "    /* Stub implementation - would process message on P-core */" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "void process_message_ecore(enhanced_msg_header_t* msg, uint8_t* payload) {" >> compatibility_layer.c
	@echo "    (void)msg; (void)payload;" >> compatibility_layer.c
	@echo "    /* Stub implementation - would process message on E-core */" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c
	@echo "" >> compatibility_layer.c
	@echo "void* work_queue_steal(void* queue) {" >> compatibility_layer.c
	@echo "    (void)queue;" >> compatibility_layer.c
	@echo "    return NULL; /* No work to steal */" >> compatibility_layer.c
	@echo "}" >> compatibility_layer.c

# Build compatibility layer
$(COMPAT_OBJS): $(COMPAT_SOURCES) compatibility_layer.h
	$(CC) $(CFLAGS) -c -o $@ $<

# Build protocol core
$(PROTOCOL_OBJS): $(PROTOCOL_SOURCES) compatibility_layer.h
	$(CC) $(CFLAGS) -c -o $@ $<

# Build test
$(TEST_OBJS): $(TEST_SOURCES) compatibility_layer.h
	$(CC) $(CFLAGS) -c -o $@ $<

# Static library
$(STATIC_LIB): $(COMPAT_OBJS) $(PROTOCOL_OBJS)
	@echo "=== Building Static Library ==="
	$(AR) rcs $@ $^
	$(RANLIB) $@

# Shared library
$(SHARED_LIB): $(COMPAT_OBJS) $(PROTOCOL_OBJS)
	@echo "=== Building Shared Library ==="
	$(CC) -shared -fPIC -Wl,-soname,libclaude-agents.so.1 -o $@ $^ $(LDFLAGS)
	ln -sf $(SHARED_LIB) libclaude-agents.so.1
	ln -sf $(SHARED_LIB) libclaude-agents.so

libs: $(STATIC_LIB) $(SHARED_LIB)

# Executables
claude-transport-test: $(PROTOCOL_SOURCES) $(COMPAT_OBJS) compatibility_layer.h
	$(CC) $(CFLAGS) -DPROTOCOL_TEST_MODE -o $@ $< $(COMPAT_OBJS) $(LDFLAGS)

claude-protocol-benchmark: $(PROTOCOL_SOURCES) $(COMPAT_OBJS) compatibility_layer.h
	$(CC) $(CFLAGS) -DBENCHMARK_MODE -o $@ $< $(COMPAT_OBJS) $(LDFLAGS)

build-test: $(TEST_SOURCES) $(COMPAT_OBJS) compatibility_layer.h
	$(CC) $(CFLAGS) -o $@ $< $(COMPAT_OBJS) $(LDFLAGS)

test: build-test
	@echo "=== Running Build Test ==="
	./build-test

clean:
	rm -f *.o *.a *.so* $(EXECUTABLES)
	rm -f compatibility_layer.h compatibility_layer.c

help:
	@echo "Claude Agent Communication System - Simplified Build"
	@echo "===================================================="
	@echo ""
	@echo "Targets:"
	@echo "  all              - Build libraries and executables"
	@echo "  libs             - Build static and shared libraries"
	@echo "  test             - Build and run basic test"
	@echo "  clean            - Clean build artifacts"
	@echo "  help             - Show this help"
	@echo ""
	@echo "Executables:"
	@echo "  claude-transport-test      - Protocol transport test"
	@echo "  claude-protocol-benchmark  - Performance benchmark"
	@echo "  build-test                - Basic build verification"