# AI-Enhanced Router Makefile
# 
# Build system for AI-enhanced routing with NPU integration
# Author: ML-OPS Agent
# Version: 1.0 Production

# ============================================================================
# CONFIGURATION
# ============================================================================

# Compiler settings
CC ?= gcc
CXX ?= g++
RUSTC ?= rustc
CARGO ?= cargo

# AI Router version
AI_ROUTER_VERSION_MAJOR = 1
AI_ROUTER_VERSION_MINOR = 0
AI_ROUTER_VERSION_PATCH = 0

# Build configuration
BUILD_TYPE ?= Release
BUILD_DIR = build
TARGET_DIR = target
INSTALL_PREFIX ?= /usr/local

# Hardware acceleration features
ENABLE_NPU ?= 1
ENABLE_GNA ?= 1
ENABLE_GPU ?= 1
ENABLE_SIMD ?= 1
ENABLE_VECTOR_DB ?= 1

# Performance optimization
OPTIMIZE_LEVEL ?= -O3
MARCH ?= native
MTUNE ?= native

# ============================================================================
# DEPENDENCIES AND LIBRARIES
# ============================================================================

# OpenVINO (for NPU support)
OPENVINO_ROOT ?= /opt/intel/openvino
OPENVINO_CFLAGS = -I$(OPENVINO_ROOT)/runtime/include
OPENVINO_LDFLAGS = -L$(OPENVINO_ROOT)/runtime/lib/intel64 -lopenvino_c

# OpenCL (for GPU support)  
OPENCL_CFLAGS = -I/usr/include/CL
OPENCL_LDFLAGS = -lOpenCL

# NUMA support
NUMA_LDFLAGS = -lnuma

# Threading and math libraries
THREAD_LDFLAGS = -lpthread -latomic
MATH_LDFLAGS = -lm

# Rust dependencies
RUST_TARGET_DIR = $(TARGET_DIR)/release

# ============================================================================
# COMPILER FLAGS
# ============================================================================

# Base flags
CFLAGS_BASE = -std=c11 -Wall -Wextra -Werror
CXXFLAGS_BASE = -std=c++17 -Wall -Wextra -Werror
RUST_FLAGS = --release

# Optimization flags
CFLAGS_OPT = $(OPTIMIZE_LEVEL) -march=$(MARCH) -mtune=$(MTUNE)
CFLAGS_OPT += -ffast-math -funroll-loops -fprefetch-loop-arrays
CFLAGS_OPT += -flto -fwhole-program -fomit-frame-pointer

# Debug flags
CFLAGS_DEBUG = -g3 -O0 -DDEBUG -fsanitize=address -fsanitize=undefined

# Feature-specific flags
ifeq ($(ENABLE_NPU),1)
    CFLAGS_FEATURES += -DENABLE_NPU=1 $(OPENVINO_CFLAGS)
    LDFLAGS_FEATURES += $(OPENVINO_LDFLAGS)
endif

ifeq ($(ENABLE_GNA),1)
    CFLAGS_FEATURES += -DENABLE_GNA=1
endif

ifeq ($(ENABLE_GPU),1)
    CFLAGS_FEATURES += -DENABLE_GPU=1 $(OPENCL_CFLAGS)
    LDFLAGS_FEATURES += $(OPENCL_LDFLAGS)
endif

ifeq ($(ENABLE_SIMD),1)
    CFLAGS_FEATURES += -DENABLE_SIMD=1 -mavx2 -mfma -mavx512f -mavx512bw
endif

# Final flags
ifeq ($(BUILD_TYPE),Debug)
    CFLAGS = $(CFLAGS_BASE) $(CFLAGS_DEBUG) $(CFLAGS_FEATURES)
    CXXFLAGS = $(CXXFLAGS_BASE) $(CFLAGS_DEBUG) $(CFLAGS_FEATURES)
else
    CFLAGS = $(CFLAGS_BASE) $(CFLAGS_OPT) $(CFLAGS_FEATURES)
    CXXFLAGS = $(CXXFLAGS_BASE) $(CFLAGS_OPT) $(CFLAGS_FEATURES)
endif

LDFLAGS = $(LDFLAGS_FEATURES) $(NUMA_LDFLAGS) $(THREAD_LDFLAGS) $(MATH_LDFLAGS)

# ============================================================================
# SOURCE FILES
# ============================================================================

# AI Router core sources
AI_ROUTER_SOURCES = \
    ai_enhanced_router.c \
    ai_router_integration.c

# Vector database (Rust)
VECTOR_DB_SOURCES = vector_router.rs

# Test sources
TEST_SOURCES = \
    test_ai_router.c \
    test_integration.c \
    benchmark_ai_router.c

# Header files
HEADER_FILES = \
    ai_enhanced_router.h \
    ultra_fast_protocol.h \
    compatibility_layer.h \
    distributed_network.h

# ============================================================================
# BUILD TARGETS
# ============================================================================

# Object files
AI_ROUTER_OBJECTS = $(AI_ROUTER_SOURCES:%.c=$(BUILD_DIR)/%.o)
TEST_OBJECTS = $(TEST_SOURCES:%.c=$(BUILD_DIR)/%.o)

# Libraries
LIBAI_ROUTER = $(BUILD_DIR)/libai_router.a
LIBAI_ROUTER_SO = $(BUILD_DIR)/libai_router.so.$(AI_ROUTER_VERSION_MAJOR).$(AI_ROUTER_VERSION_MINOR).$(AI_ROUTER_VERSION_PATCH)
LIBAI_ROUTER_SO_LINK = $(BUILD_DIR)/libai_router.so

# Vector database library (Rust)
LIBVECTOR_DB = $(RUST_TARGET_DIR)/libvector_router.a

# Executables
AI_ROUTER_TEST = $(BUILD_DIR)/ai_router_test
AI_INTEGRATION_TEST = $(BUILD_DIR)/ai_integration_test
AI_ROUTER_BENCHMARK = $(BUILD_DIR)/ai_router_benchmark

# ============================================================================
# BUILD RULES
# ============================================================================

.PHONY: all clean install uninstall test benchmark vector-db help

# Default target
all: $(LIBAI_ROUTER) $(LIBAI_ROUTER_SO) vector-db

# Create build directory
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# Compile C sources
$(BUILD_DIR)/%.o: %.c | $(BUILD_DIR)
	@echo "Compiling $< -> $@"
	$(CC) $(CFLAGS) -fPIC -c $< -o $@

# Build static library
$(LIBAI_ROUTER): $(AI_ROUTER_OBJECTS)
	@echo "Creating static library $@"
	$(AR) rcs $@ $^

# Build shared library
$(LIBAI_ROUTER_SO): $(AI_ROUTER_OBJECTS)
	@echo "Creating shared library $@"
	$(CC) -shared -Wl,-soname,libai_router.so.$(AI_ROUTER_VERSION_MAJOR) -o $@ $^ $(LDFLAGS)
	@cd $(BUILD_DIR) && ln -sf $(notdir $(LIBAI_ROUTER_SO)) $(notdir $(LIBAI_ROUTER_SO_LINK))

# Build vector database (Rust)
vector-db: $(LIBVECTOR_DB)

$(LIBVECTOR_DB): vector_router.rs Cargo.toml
	@echo "Building Rust vector database library"
	$(CARGO) build $(RUST_FLAGS)
	@echo "Vector database library built: $@"

# Build tests
test: $(AI_ROUTER_TEST) $(AI_INTEGRATION_TEST)

$(AI_ROUTER_TEST): $(BUILD_DIR)/test_ai_router.o $(LIBAI_ROUTER) | $(BUILD_DIR)
	@echo "Building AI router test: $@"
	$(CC) -o $@ $< $(LIBAI_ROUTER) $(LDFLAGS) -DAI_ROUTER_TEST_MODE

$(AI_INTEGRATION_TEST): $(BUILD_DIR)/test_integration.o $(LIBAI_ROUTER) | $(BUILD_DIR)
	@echo "Building integration test: $@"
	$(CC) -o $@ $< $(LIBAI_ROUTER) $(LDFLAGS) -DAI_INTEGRATION_TEST_MODE

# Build benchmark
benchmark: $(AI_ROUTER_BENCHMARK)

$(AI_ROUTER_BENCHMARK): $(BUILD_DIR)/benchmark_ai_router.o $(LIBAI_ROUTER) | $(BUILD_DIR)
	@echo "Building AI router benchmark: $@"
	$(CC) -o $@ $< $(LIBAI_ROUTER) $(LDFLAGS)

# ============================================================================
# INSTALLATION
# ============================================================================

install: all
	@echo "Installing AI Router libraries and headers..."
	install -d $(DESTDIR)$(INSTALL_PREFIX)/lib
	install -d $(DESTDIR)$(INSTALL_PREFIX)/include/ai_router
	
	# Install libraries
	install -m 644 $(LIBAI_ROUTER) $(DESTDIR)$(INSTALL_PREFIX)/lib/
	install -m 755 $(LIBAI_ROUTER_SO) $(DESTDIR)$(INSTALL_PREFIX)/lib/
	cd $(DESTDIR)$(INSTALL_PREFIX)/lib && ln -sf $(notdir $(LIBAI_ROUTER_SO)) libai_router.so
	
	# Install headers
	install -m 644 ai_enhanced_router.h $(DESTDIR)$(INSTALL_PREFIX)/include/ai_router/
	
	# Install Rust library if built
	if [ -f $(LIBVECTOR_DB) ]; then \
		install -m 644 $(LIBVECTOR_DB) $(DESTDIR)$(INSTALL_PREFIX)/lib/; \
	fi
	
	# Update library cache
	ldconfig $(DESTDIR)$(INSTALL_PREFIX)/lib
	
	@echo "Installation complete."

uninstall:
	@echo "Uninstalling AI Router..."
	rm -f $(DESTDIR)$(INSTALL_PREFIX)/lib/libai_router.*
	rm -f $(DESTDIR)$(INSTALL_PREFIX)/lib/libvector_router.*
	rm -rf $(DESTDIR)$(INSTALL_PREFIX)/include/ai_router
	ldconfig $(DESTDIR)$(INSTALL_PREFIX)/lib
	@echo "Uninstallation complete."

# ============================================================================
# TESTING AND BENCHMARKING
# ============================================================================

# Run tests
run-tests: test
	@echo "Running AI Router tests..."
	@echo "=========================="
	@echo "1. Core AI Router functionality:"
	$(AI_ROUTER_TEST)
	@echo ""
	@echo "2. Integration layer tests:"
	$(AI_INTEGRATION_TEST)
	@echo ""
	@echo "All tests completed."

# Run benchmarks
run-benchmark: benchmark
	@echo "Running AI Router benchmarks..."
	@echo "==============================="
	$(AI_ROUTER_BENCHMARK) 30
	@echo "Benchmark completed."

# Performance profiling
profile: benchmark
	@echo "Profiling AI Router performance..."
	perf record -g $(AI_ROUTER_BENCHMARK) 10
	perf report

# Memory analysis
memory-check: test
	@echo "Running memory analysis..."
	valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all $(AI_ROUTER_TEST)

# ============================================================================
# DEVELOPMENT TOOLS
# ============================================================================

# Format code
format:
	@echo "Formatting source code..."
	clang-format -i *.c *.h
	$(CARGO) fmt

# Static analysis
analyze:
	@echo "Running static analysis..."
	clang-static-analyzer *.c
	$(CARGO) clippy

# Generate documentation
docs:
	@echo "Generating documentation..."
	doxygen Doxyfile
	$(CARGO) doc

# Code coverage
coverage: test
	@echo "Generating code coverage report..."
	gcov $(AI_ROUTER_SOURCES)
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory coverage_html

# ============================================================================
# MODEL MANAGEMENT
# ============================================================================

# Download pre-trained models
download-models:
	@echo "Downloading AI routing models..."
	mkdir -p models
	# Load predictor model (ONNX format)
	wget -O models/load_predictor.onnx "https://example.com/models/load_predictor.onnx"
	# Anomaly detector model (OpenVINO IR format)
	wget -O models/anomaly_detector.xml "https://example.com/models/anomaly_detector.xml"
	wget -O models/anomaly_detector.bin "https://example.com/models/anomaly_detector.bin"
	# Semantic router model
	wget -O models/semantic_router.bin "https://example.com/models/semantic_router.bin"
	@echo "Models downloaded to ./models/"

# Convert models for NPU
convert-models: download-models
	@echo "Converting models for NPU optimization..."
	# Convert ONNX to OpenVINO IR with NPU optimizations
	mo --input_model models/load_predictor.onnx --output_dir models/ --data_type FP16
	# Optimize for NPU
	pot -c pot_config.json
	@echo "Model conversion completed."

# Validate models
validate-models:
	@echo "Validating AI routing models..."
	python3 scripts/validate_models.py models/
	@echo "Model validation completed."

# ============================================================================
# DOCKER INTEGRATION
# ============================================================================

# Build Docker image
docker-build:
	@echo "Building AI Router Docker image..."
	docker build -t ai-router:$(AI_ROUTER_VERSION_MAJOR).$(AI_ROUTER_VERSION_MINOR) .

# Run in Docker
docker-run: docker-build
	@echo "Running AI Router in Docker..."
	docker run --rm -it \
		--device=/dev/dri:/dev/dri \
		--device=/dev/gna0:/dev/gna0 \
		-v $(PWD)/models:/models:ro \
		ai-router:$(AI_ROUTER_VERSION_MAJOR).$(AI_ROUTER_VERSION_MINOR)

# Docker test
docker-test: docker-build
	@echo "Running tests in Docker..."
	docker run --rm \
		--device=/dev/dri:/dev/dri \
		ai-router:$(AI_ROUTER_VERSION_MAJOR).$(AI_ROUTER_VERSION_MINOR) \
		make run-tests

# ============================================================================
# CONTINUOUS INTEGRATION
# ============================================================================

# CI build (all configurations)
ci-build:
	@echo "Running CI build for all configurations..."
	@echo "1. Debug build with all features:"
	$(MAKE) clean && $(MAKE) BUILD_TYPE=Debug ENABLE_NPU=1 ENABLE_GNA=1 ENABLE_GPU=1
	@echo "2. Release build with NPU only:"
	$(MAKE) clean && $(MAKE) BUILD_TYPE=Release ENABLE_NPU=1 ENABLE_GNA=0 ENABLE_GPU=0
	@echo "3. CPU-only build:"
	$(MAKE) clean && $(MAKE) BUILD_TYPE=Release ENABLE_NPU=0 ENABLE_GNA=0 ENABLE_GPU=0
	@echo "CI build completed successfully."

# CI test suite
ci-test: ci-build
	@echo "Running CI test suite..."
	$(MAKE) run-tests
	$(MAKE) run-benchmark
	$(MAKE) memory-check
	@echo "CI test suite completed."

# ============================================================================
# CLEANUP
# ============================================================================

clean:
	@echo "Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)
	$(CARGO) clean
	rm -f *.gcov *.gcda *.gcno
	rm -f coverage.info
	rm -rf coverage_html
	rm -f perf.data*
	@echo "Cleanup completed."

distclean: clean
	@echo "Cleaning all generated files..."
	rm -rf models/
	rm -rf docs/
	@echo "Deep cleanup completed."

# ============================================================================
# HELP
# ============================================================================

help:
	@echo "AI-Enhanced Router Build System"
	@echo "==============================="
	@echo ""
	@echo "Build targets:"
	@echo "  all              - Build all libraries (default)"
	@echo "  vector-db        - Build Rust vector database library"
	@echo "  test             - Build test executables"
	@echo "  benchmark        - Build benchmark executable"
	@echo ""
	@echo "Installation:"
	@echo "  install          - Install libraries and headers"
	@echo "  uninstall        - Remove installed files"
	@echo ""
	@echo "Testing:"
	@echo "  run-tests        - Run all tests"
	@echo "  run-benchmark    - Run performance benchmarks"
	@echo "  profile          - Profile with perf"
	@echo "  memory-check     - Check for memory leaks"
	@echo "  coverage         - Generate code coverage report"
	@echo ""
	@echo "Development:"
	@echo "  format           - Format source code"
	@echo "  analyze          - Run static analysis"
	@echo "  docs             - Generate documentation"
	@echo ""
	@echo "Models:"
	@echo "  download-models  - Download pre-trained models"
	@echo "  convert-models   - Convert models for NPU"
	@echo "  validate-models  - Validate model integrity"
	@echo ""
	@echo "Docker:"
	@echo "  docker-build     - Build Docker image"
	@echo "  docker-run       - Run in Docker container"
	@echo "  docker-test      - Run tests in Docker"
	@echo ""
	@echo "CI/CD:"
	@echo "  ci-build         - Build all configurations"
	@echo "  ci-test          - Run full CI test suite"
	@echo ""
	@echo "Cleanup:"
	@echo "  clean            - Remove build artifacts"
	@echo "  distclean        - Remove all generated files"
	@echo ""
	@echo "Configuration options:"
	@echo "  BUILD_TYPE       - Debug or Release (default: Release)"
	@echo "  ENABLE_NPU       - Enable NPU support (default: 1)"
	@echo "  ENABLE_GNA       - Enable GNA support (default: 1)"
	@echo "  ENABLE_GPU       - Enable GPU support (default: 1)"
	@echo "  ENABLE_SIMD      - Enable SIMD optimizations (default: 1)"
	@echo ""
	@echo "Examples:"
	@echo "  make BUILD_TYPE=Debug ENABLE_NPU=0"
	@echo "  make install INSTALL_PREFIX=/opt/ai_router"
	@echo "  make run-tests"
	@echo "  make docker-build"

# ============================================================================
# VERSION INFO
# ============================================================================

version:
	@echo "AI-Enhanced Router Build System"
	@echo "Version: $(AI_ROUTER_VERSION_MAJOR).$(AI_ROUTER_VERSION_MINOR).$(AI_ROUTER_VERSION_PATCH)"
	@echo "Build type: $(BUILD_TYPE)"
	@echo "Features:"
	@echo "  NPU support: $(ENABLE_NPU)"
	@echo "  GNA support: $(ENABLE_GNA)"  
	@echo "  GPU support: $(ENABLE_GPU)"
	@echo "  SIMD support: $(ENABLE_SIMD)"
	@echo "  Vector DB support: $(ENABLE_VECTOR_DB)"
	@echo "Install prefix: $(INSTALL_PREFIX)"

# ============================================================================
# DEPENDENCY TRACKING
# ============================================================================

# Include dependency files
-include $(AI_ROUTER_OBJECTS:.o=.d)
-include $(TEST_OBJECTS:.o=.d)

# Generate dependencies
$(BUILD_DIR)/%.d: %.c | $(BUILD_DIR)
	@$(CC) $(CFLAGS) -MM -MT '$@ $(BUILD_DIR)/$*.o' $< > $@