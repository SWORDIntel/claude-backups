# CLAUDE AGENTS SECURITY FRAMEWORK MAKEFILE
# High-performance security build with enterprise compliance
#
# Build targets:
#   make security        - Build security framework
#   make security-test   - Build security test suite
#   make security-bench  - Build security benchmarks
#   make install-security - Install security components
#   make clean-security  - Clean security build artifacts
#
# Performance optimizations:
#   - Hardware acceleration (AES-NI, SHA-NI, AVX-512)
#   - Link-time optimization (LTO)
#   - Profile-guided optimization (PGO)
#   - Intel Compiler optimizations
#   - OpenSSL 3.0 optimizations

# Compiler and version detection
CC := $(shell command -v icc 2>/dev/null || echo gcc)
CXX := $(shell command -v icpc 2>/dev/null || echo g++)

# Version information
SECURITY_VERSION_MAJOR := 1
SECURITY_VERSION_MINOR := 0
SECURITY_VERSION_PATCH := 0
SECURITY_VERSION := $(SECURITY_VERSION_MAJOR).$(SECURITY_VERSION_MINOR).$(SECURITY_VERSION_PATCH)

# Directories
SECURITY_SRC_DIR := .
SECURITY_BUILD_DIR := build/security
SECURITY_INSTALL_DIR := /usr/local/lib/claude-agents
SECURITY_CONFIG_DIR := /etc/claude-agents
SECURITY_LOG_DIR := /var/log/claude-agents

# Source files
SECURITY_SOURCES := \
	auth_security.c \
	security_integration.c \
	tls_manager.c

SECURITY_HEADERS := \
	auth_security.h \
	ultra_fast_protocol.h

SECURITY_OBJECTS := $(SECURITY_SOURCES:%.c=$(SECURITY_BUILD_DIR)/%.o)

# Test sources
SECURITY_TEST_SOURCES := \
	tests/test_jwt.c \
	tests/test_hmac.c \
	tests/test_tls.c \
	tests/test_rbac.c \
	tests/test_rate_limiting.c \
	tests/test_ddos_protection.c \
	tests/test_integration.c

SECURITY_TEST_OBJECTS := $(SECURITY_TEST_SOURCES:%.c=$(SECURITY_BUILD_DIR)/%.o)

# Benchmark sources
SECURITY_BENCH_SOURCES := \
	benchmarks/bench_jwt.c \
	benchmarks/bench_hmac.c \
	benchmarks/bench_tls.c \
	benchmarks/bench_crypto.c \
	benchmarks/bench_integration.c

SECURITY_BENCH_OBJECTS := $(SECURITY_BENCH_SOURCES:%.c=$(SECURITY_BUILD_DIR)/%.o)

# Detect CPU features
CPU_FLAGS := $(shell grep -m1 flags /proc/cpuinfo)
HAS_AES_NI := $(shell echo $(CPU_FLAGS) | grep -q aes && echo 1 || echo 0)
HAS_SHA_NI := $(shell echo $(CPU_FLAGS) | grep -q sha_ni && echo 1 || echo 0)
HAS_AVX512 := $(shell echo $(CPU_FLAGS) | grep -q avx512f && echo 1 || echo 0)
HAS_AVX2 := $(shell echo $(CPU_FLAGS) | grep -q avx2 && echo 1 || echo 0)

# Detect available libraries
HAS_OPENSSL3 := $(shell pkg-config --exists 'openssl >= 3.0.0' && echo 1 || echo 0)
HAS_LIBURING := $(shell pkg-config --exists liburing && echo 1 || echo 0)
HAS_JSON_C := $(shell pkg-config --exists json-c && echo 1 || echo 0)
HAS_QAT := $(shell test -f /usr/include/qat/qae_mem.h && echo 1 || echo 0)

# Base compiler flags
CFLAGS := -std=gnu11 -fPIC -Wall -Wextra -Werror
CPPFLAGS := -D_GNU_SOURCE -D_FORTIFY_SOURCE=2

# Security hardening flags
SECURITY_CFLAGS := \
	-fstack-protector-strong \
	-fstack-clash-protection \
	-fcf-protection=full \
	-Wformat -Wformat-security \
	-Werror=format-security \
	-pie -fPIE

# Performance optimization flags
ifeq ($(CC),icc)
    # Intel Compiler optimizations
    PERF_CFLAGS := \
        -O3 -ipo -no-prec-div -fp-model fast=2 \
        -xHost -march=native -mtune=native \
        -funroll-loops -ffast-math \
        -flto=full -ffat-lto-objects
else
    # GCC optimizations
    PERF_CFLAGS := \
        -O3 -march=native -mtune=native \
        -funroll-loops -ffast-math \
        -flto -ffat-lto-objects \
        -fuse-linker-plugin
endif

# Hardware acceleration flags
ifeq ($(HAS_AES_NI),1)
    CPPFLAGS += -DHAVE_AES_NI=1
    PERF_CFLAGS += -maes
endif

ifeq ($(HAS_SHA_NI),1)
    CPPFLAGS += -DHAVE_SHA_NI=1
    PERF_CFLAGS += -msha
endif

ifeq ($(HAS_AVX512),1)
    CPPFLAGS += -DHAVE_AVX512=1
    PERF_CFLAGS += -mavx512f -mavx512bw -mavx512cd -mavx512dq -mavx512vl
else ifeq ($(HAS_AVX2),1)
    CPPFLAGS += -DHAVE_AVX2=1
    PERF_CFLAGS += -mavx2
endif

# Library detection and flags
ifeq ($(HAS_OPENSSL3),1)
    CPPFLAGS += -DHAVE_OPENSSL3=1
    LDLIBS += $(shell pkg-config --libs 'openssl >= 3.0.0')
    CFLAGS += $(shell pkg-config --cflags 'openssl >= 3.0.0')
else
    LDLIBS += -lssl -lcrypto
endif

ifeq ($(HAS_LIBURING),1)
    CPPFLAGS += -DHAVE_LIBURING=1
    LDLIBS += $(shell pkg-config --libs liburing)
    CFLAGS += $(shell pkg-config --cflags liburing)
endif

ifeq ($(HAS_JSON_C),1)
    CPPFLAGS += -DHAVE_JSON_C=1
    LDLIBS += $(shell pkg-config --libs json-c)
    CFLAGS += $(shell pkg-config --cflags json-c)
else
    $(warning json-c not found - JWT functionality will be limited)
endif

ifeq ($(HAS_QAT),1)
    CPPFLAGS += -DHAVE_QAT=1
    LDLIBS += -lqat_s -lusdm_drv_s
    CFLAGS += -I/usr/include/qat
endif

# Additional libraries
LDLIBS += -lpthread -lm -ldl -lrt

# Version information
CPPFLAGS += \
	-DSECURITY_VERSION_MAJOR=$(SECURITY_VERSION_MAJOR) \
	-DSECURITY_VERSION_MINOR=$(SECURITY_VERSION_MINOR) \
	-DSECURITY_VERSION_PATCH=$(SECURITY_VERSION_PATCH) \
	-DSECURITY_VERSION=\"$(SECURITY_VERSION)\"

# Debug vs Release builds
ifdef DEBUG
    CFLAGS += -g -O0 -DDEBUG
    CPPFLAGS += -DSECURITY_DEBUG=1
else
    CFLAGS += $(PERF_CFLAGS) -DNDEBUG
    CPPFLAGS += -DSECURITY_RELEASE=1
    LDFLAGS += -Wl,-O1 -Wl,--as-needed -Wl,--no-undefined
endif

# Combine all flags
ALL_CFLAGS := $(CFLAGS) $(SECURITY_CFLAGS) $(CPPFLAGS)

# Build rules
.PHONY: security security-test security-bench install-security clean-security
.PHONY: security-info security-deps check-security benchmark-security

# Default target
security: $(SECURITY_BUILD_DIR)/libclaude_security.so $(SECURITY_BUILD_DIR)/libclaude_security.a

# Shared library
$(SECURITY_BUILD_DIR)/libclaude_security.so: $(SECURITY_OBJECTS)
	@echo "Linking shared security library..."
	@mkdir -p $(dir $@)
	$(CC) -shared $(LDFLAGS) -o $@ $^ $(LDLIBS)
	@echo "Built $@"

# Static library
$(SECURITY_BUILD_DIR)/libclaude_security.a: $(SECURITY_OBJECTS)
	@echo "Creating static security library..."
	@mkdir -p $(dir $@)
	$(AR) rcs $@ $^
	@echo "Built $@"

# Object files
$(SECURITY_BUILD_DIR)/%.o: %.c $(SECURITY_HEADERS)
	@echo "Compiling $<..."
	@mkdir -p $(dir $@)
	$(CC) $(ALL_CFLAGS) -c -o $@ $<

# Test suite
security-test: $(SECURITY_BUILD_DIR)/security_test_suite

$(SECURITY_BUILD_DIR)/security_test_suite: $(SECURITY_TEST_OBJECTS) $(SECURITY_OBJECTS)
	@echo "Building security test suite..."
	@mkdir -p $(dir $@)
	$(CC) $(ALL_CFLAGS) $(LDFLAGS) -o $@ $^ $(LDLIBS) -lcunit
	@echo "Built $@"

# Test object files
$(SECURITY_BUILD_DIR)/tests/%.o: tests/%.c $(SECURITY_HEADERS)
	@echo "Compiling test $<..."
	@mkdir -p $(dir $@)
	$(CC) $(ALL_CFLAGS) -c -o $@ $<

# Benchmark suite
security-bench: $(SECURITY_BUILD_DIR)/security_benchmark_suite

$(SECURITY_BUILD_DIR)/security_benchmark_suite: $(SECURITY_BENCH_OBJECTS) $(SECURITY_OBJECTS)
	@echo "Building security benchmark suite..."
	@mkdir -p $(dir $@)
	$(CC) $(ALL_CFLAGS) $(LDFLAGS) -o $@ $^ $(LDLIBS)
	@echo "Built $@"

# Benchmark object files
$(SECURITY_BUILD_DIR)/benchmarks/%.o: benchmarks/%.c $(SECURITY_HEADERS)
	@echo "Compiling benchmark $<..."
	@mkdir -p $(dir $@)
	$(CC) $(ALL_CFLAGS) -c -o $@ $<

# Display build information
security-info:
	@echo "=== Claude Agents Security Framework Build Information ==="
	@echo "Version: $(SECURITY_VERSION)"
	@echo "Compiler: $(CC)"
	@echo "Target: $(shell $(CC) -dumpmachine)"
	@echo ""
	@echo "Hardware Acceleration:"
	@echo "  AES-NI: $(if $(filter 1,$(HAS_AES_NI)),YES,NO)"
	@echo "  SHA-NI: $(if $(filter 1,$(HAS_SHA_NI)),YES,NO)"
	@echo "  AVX-512: $(if $(filter 1,$(HAS_AVX512)),YES,NO)"
	@echo "  AVX2: $(if $(filter 1,$(HAS_AVX2)),YES,NO)"
	@echo ""
	@echo "Library Dependencies:"
	@echo "  OpenSSL 3.0+: $(if $(filter 1,$(HAS_OPENSSL3)),YES,NO)"
	@echo "  io_uring: $(if $(filter 1,$(HAS_LIBURING)),YES,NO)"
	@echo "  json-c: $(if $(filter 1,$(HAS_JSON_C)),YES,NO)"
	@echo "  Intel QAT: $(if $(filter 1,$(HAS_QAT)),YES,NO)"
	@echo ""
	@echo "Build Flags:"
	@echo "  CFLAGS: $(ALL_CFLAGS)"
	@echo "  LDLIBS: $(LDLIBS)"
	@echo "=========================================================="

# Check dependencies
security-deps:
	@echo "Checking security framework dependencies..."
	@command -v pkg-config >/dev/null 2>&1 || \
		(echo "ERROR: pkg-config not found" && exit 1)
	@pkg-config --exists openssl || \
		(echo "ERROR: OpenSSL development headers not found" && exit 1)
	@test -f /usr/include/pthread.h || \
		(echo "ERROR: pthread development headers not found" && exit 1)
	@echo "All dependencies satisfied."

# Run security tests
check-security: security-test
	@echo "Running security test suite..."
	$(SECURITY_BUILD_DIR)/security_test_suite
	@echo "Security tests completed."

# Run security benchmarks
benchmark-security: security-bench
	@echo "Running security benchmark suite..."
	$(SECURITY_BUILD_DIR)/security_benchmark_suite
	@echo "Security benchmarks completed."

# Installation
install-security: security
	@echo "Installing Claude Agents Security Framework..."
	install -d $(SECURITY_INSTALL_DIR)
	install -d $(SECURITY_CONFIG_DIR)
	install -d $(SECURITY_LOG_DIR)
	
	# Install libraries
	install -m 755 $(SECURITY_BUILD_DIR)/libclaude_security.so $(SECURITY_INSTALL_DIR)/
	install -m 644 $(SECURITY_BUILD_DIR)/libclaude_security.a $(SECURITY_INSTALL_DIR)/
	
	# Install headers
	install -d $(SECURITY_INSTALL_DIR)/include
	install -m 644 $(SECURITY_HEADERS) $(SECURITY_INSTALL_DIR)/include/
	
	# Install configuration
	install -m 644 security_config.json $(SECURITY_CONFIG_DIR)/
	
	# Install pkg-config file
	install -d /usr/local/lib/pkgconfig
	sed -e 's|@PREFIX@|/usr/local|g' \
	    -e 's|@VERSION@|$(SECURITY_VERSION)|g' \
	    security.pc.in > $(SECURITY_BUILD_DIR)/claude-security.pc
	install -m 644 $(SECURITY_BUILD_DIR)/claude-security.pc /usr/local/lib/pkgconfig/
	
	# Update library cache
	ldconfig
	
	@echo "Installation completed."

# Cleanup
clean-security:
	@echo "Cleaning security build artifacts..."
	rm -rf $(SECURITY_BUILD_DIR)
	@echo "Clean completed."

# Create necessary test and benchmark directories
$(SECURITY_BUILD_DIR)/tests $(SECURITY_BUILD_DIR)/benchmarks:
	@mkdir -p $@

# Profile-guided optimization build (advanced)
pgo-security: clean-security
	@echo "Building with Profile-Guided Optimization..."
	$(MAKE) security CFLAGS="$(CFLAGS) -fprofile-generate"
	@echo "Running training workload..."
	./$(SECURITY_BUILD_DIR)/security_benchmark_suite --training
	$(MAKE) clean-security
	$(MAKE) security CFLAGS="$(CFLAGS) -fprofile-use"
	@echo "PGO build completed."

# Docker build support
docker-security:
	docker build -f Dockerfile.security -t claude-agents-security:$(SECURITY_VERSION) .

# Code coverage analysis (debug builds only)
coverage-security:
ifdef DEBUG
	$(MAKE) security CFLAGS="$(CFLAGS) --coverage"
	$(MAKE) check-security
	gcov $(SECURITY_SOURCES)
	lcov --capture --directory . --output-file security_coverage.info
	genhtml security_coverage.info --output-directory coverage_report
	@echo "Coverage report generated in coverage_report/"
else
	@echo "ERROR: Coverage analysis requires DEBUG=1"
	@exit 1
endif

# Memory leak detection with Valgrind
valgrind-security: security-test
	valgrind --leak-check=full --show-leak-kinds=all \
		--track-origins=yes --tool=memcheck \
		$(SECURITY_BUILD_DIR)/security_test_suite

# Static analysis with cppcheck
analyze-security:
	cppcheck --enable=all --std=c11 --platform=unix64 \
		--suppress=missingIncludeSystem \
		--xml --xml-version=2 \
		$(SECURITY_SOURCES) 2> security_analysis.xml

# Help target
help-security:
	@echo "Claude Agents Security Framework Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  security           - Build security framework libraries"
	@echo "  security-test      - Build and run test suite"
	@echo "  security-bench     - Build and run benchmarks"
	@echo "  security-info      - Display build configuration"
	@echo "  security-deps      - Check build dependencies"
	@echo "  check-security     - Run security tests"
	@echo "  benchmark-security - Run security benchmarks"
	@echo "  install-security   - Install security components"
	@echo "  clean-security     - Clean build artifacts"
	@echo "  pgo-security       - Profile-guided optimization build"
	@echo "  coverage-security  - Generate code coverage report (DEBUG=1)"
	@echo "  valgrind-security  - Run memory leak detection"
	@echo "  analyze-security   - Run static analysis"
	@echo ""
	@echo "Build variables:"
	@echo "  DEBUG=1            - Enable debug build"
	@echo "  CC=compiler        - Specify C compiler"
	@echo "  DESTDIR=path       - Installation prefix"
	@echo ""
	@echo "Example usage:"
	@echo "  make security              - Release build"
	@echo "  make security DEBUG=1      - Debug build"
	@echo "  make check-security        - Run tests"
	@echo "  make install-security      - Install system-wide"